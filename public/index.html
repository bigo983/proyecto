<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1F2937">
  <meta name="description" content="Control de horarios y geolocalizaci√≥n">
  <title>FichaApp - Control de Horarios</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,<svg xmlns='https://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%231F2937' width='192' height='192'/><text x='96' y='120' font-size='80' font-weight='bold' fill='white' text-anchor='middle'>F</text></svg>">
  <link rel="stylesheet" href="/gdpr-banner.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="/gdpr-banner.js" defer></script>
  <style>
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="bg-gray-100">
  <div id="app"></div>

  <script>
    /*
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js', { updateViaCache: 'none' })
        .then((reg) => {
          console.log('‚úì Service Worker registrado');
          // Ask the browser to check for an updated SW script immediately.
          try { reg.update(); } catch (_) { }
        })
        .catch(err => console.error('Error al registrar Service Worker:', err));
    }
    */

    // --- Multi-tenant helper (company context) ---
    // The backend expects a company subdomain context. When browsing via
    // https://agendaloya.es/?company=pepe, normal fetch('/api/...') calls do not
    // include the query param. To make the app reliable, we inject the company
    // into a header on every same-origin /api/* request.
    function resolveCompanySubdomain() {
      const urlParams = new URLSearchParams(window.location.search);
      const companyFromQuery = (urlParams.get('company') || '').toLowerCase().trim();
      const hostParts = window.location.hostname.split('.');
      const companyFromHost = hostParts.length > 2 && hostParts[0] !== 'www' ? hostParts[0].toLowerCase().trim() : '';
      const companyFromStorage = (localStorage.getItem('company_subdomain') || '').toLowerCase().trim();
      const resolved = companyFromHost || companyFromQuery || companyFromStorage || '';
      return resolved;
    }

    // Persist query company in localStorage so other pages (/superadmin.html -> /dashboard.html)
    // still have tenant context.
    try {
      const qp = new URLSearchParams(window.location.search).get('company');
      if (qp) localStorage.setItem('company_subdomain', String(qp).toLowerCase().trim());
    } catch (_) { }

    (function patchFetchForCompany() {
      if (!window.fetch) return;
      const originalFetch = window.fetch.bind(window);

      window.fetch = (input, init) => {
        try {
          const reqInit = init ? { ...init } : {};
          const url = typeof input === 'string'
            ? new URL(input, window.location.origin)
            : new URL(input.url, window.location.origin);

          // Only add header for same-origin API calls.
          if (url.origin === window.location.origin && url.pathname.startsWith('/api/')) {
            const company = resolveCompanySubdomain();
            if (company) {
              const headers = new Headers(reqInit.headers || (typeof input !== 'string' ? input.headers : undefined) || {});
              if (!headers.has('x-company-subdomain')) {
                headers.set('x-company-subdomain', company);
              }
              reqInit.headers = headers;
              return originalFetch(input, reqInit);
            }
          }
        } catch (_) {
          // fall through
        }
        return originalFetch(input, init);
      };
    })();

    let currentUser = null;
    let users = [];

    async function loadUsers() {
      try {
        const response = await fetch('/api/users');
        users = await response.json();
      } catch (error) {
        console.error('Error cargando usuarios:', error);
      }
    }

    function renderLogin() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center p-4">
          <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md border-2 border-slate-200">
            <h1 class="text-3xl font-bold text-center text-slate-800 mb-2">FichaApp</h1>
            <p class="text-center text-slate-600 mb-8 font-semibold">Control de Horarios y Geolocalizaci√≥n</p>
            
            <div class="space-y-4">
              <div>
                 <label class="block text-slate-700 font-semibold mb-2">Usuario:</label>
                 <input type="text" id="loginUser" class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ej: admin">
              </div>
              
              <div>
                 <label class="block text-slate-700 font-semibold mb-2">Contrase√±a:</label>
                 <input type="password" id="loginPassword" class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="******" onkeypress="if(event.key === 'Enter') login()">
              </div>
              
              <div class="text-right mb-2">
                <a href="#" onclick="solicitarResetPassword(); return false;" class="text-sm text-cyan-600 hover:underline">¬øOlvidaste tu contrase√±a?</a>
              </div>
              
              <button onclick="login()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-lg">
                Iniciar Sesi√≥n
              </button>
              
              <div class="relative">
                <div class="absolute inset-0 flex items-center">
                  <div class="w-full border-t border-slate-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                  <span class="px-2 bg-white text-slate-500">o</span>
                </div>
              </div>
              
              <button id="login-qr-button" onclick="mostrarVistaQR()" class="w-full bg-gradient-to-r from-purple-600 to-fuchsia-600 hover:from-purple-700 hover:to-fuchsia-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-lg">
                üì± Mostrar QR para Fichar
              </button>
            </div>
            
            <p class="mt-4 text-xs text-center text-slate-400">Contrase√±a por defecto: 123456</p>

            <!-- Registro de empresa deshabilitado: solo SuperAdmin crea empresas -->
          </div>
        </div>
      `;

      // Ocultar QR si la empresa est√° desactivada
      setTimeout(actualizarDisponibilidadQRLogin, 0);
    }

    async function actualizarDisponibilidadQRLogin() {
      try {
        const res = await fetch('/api/company/status');
        if (!res.ok) return;
        const st = await res.json();
        if (st && st.active === false) {
          const btn = document.getElementById('login-qr-button');
          if (btn) btn.classList.add('hidden');
        }
      } catch (_) {
        // noop
      }
    }

    async function login() {
      const username = document.getElementById('loginUser').value;
      const password = document.getElementById('loginPassword').value;

      if (!username || !password) {
        Swal.fire('Error', 'Por favor ingresa usuario y contrase√±a', 'error');
        return;
      }

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (!response.ok) {
          Swal.fire('Error', data.error || 'Login fallido', 'error');
          return;
        }

        // Guardar token y usuario
        console.log('DEBUG: Login successful. Response data:', data);
        localStorage.setItem('fichaapp_token', data.token);

        if (data.user.company && data.user.company.subdomain) {
          console.log('DEBUG: Saving company subdomain to storage:', data.user.company.subdomain);
          localStorage.setItem('company_subdomain', data.user.company.subdomain);
          // Also update the global variable if it was empty, might need a reload in some architectures but here we rely on fetch patch
        } else {
          console.error('DEBUG: Login response missing company subdomain!', data);
        }
        currentUser = data.user;

        if (currentUser.rol === 'admin') {
          renderAdmin();
        } else if (currentUser.rol === 'superadmin') {
          window.location.href = '/superadmin.html';
        } else {
          renderEmployee();
        }
      } catch (error) {
        Swal.fire('Error', 'Error de conexi√≥n', 'error');
        console.error(error);
      }
    }

    async function solicitarResetPassword() {
      const { value: username } = await Swal.fire({
        title: 'Restablecer Contrase√±a',
        input: 'text',
        inputLabel: 'Ingresa tu usuario o email',
        inputPlaceholder: 'usuario',
        showCancelButton: true,
        confirmButtonText: 'Enviar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#0891b2',
        inputValidator: (value) => {
          if (!value) {
            return 'Debes ingresar un usuario';
          }
        }
      });

      if (!username) return;

      try {
        const res = await fetch('/api/request-password-reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });

        const data = await res.json();

        if (data.devLink) {
          // En desarrollo, mostrar el link directamente
          await Swal.fire({
            icon: 'info',
            title: 'Link de Reseteo (DEV)',
            html: `Copia este link para restablecer tu contrase√±a:<br><br><a href="${data.devLink}" class="text-blue-600 underline break-all">${data.devLink}</a>`,
            confirmButtonColor: '#0891b2'
          });
        } else {
          Swal.fire({
            icon: 'success',
            title: '¬°Solicitud Enviada!',
            text: data.message || 'Revisa tu email para continuar',
            confirmButtonColor: '#0891b2'
          });
        }
      } catch (error) {
        Swal.fire('Error', 'Error al solicitar reseteo de contrase√±a', 'error');
      }
    }

    async function mostrarVistaQR() {
      // Si la empresa est√° desactivada, no permitir QR
      try {
        const stRes = await fetch('/api/company/status');
        if (stRes.ok) {
          const st = await stRes.json();
          if (st && st.active === false) {
            Swal.fire('Empresa desactivada', 'Esta empresa est√° desactivada. Contacta con soporte.', 'warning');
            return;
          }
        }
      } catch (_) {
        // noop
      }

      // Obtener el PIN de la configuraci√≥n
      const configRes = await fetch('/api/config');
      const config = await configRes.json();
      const pinCorrecto = config.qr_pin || '1234';

      const { value: pin } = await Swal.fire({
        title: 'üîí Acceso Seguro',
        html: `
          <p class="mb-4 text-sm text-gray-600">Introduce el PIN para mostrar el QR de fichaje</p>
          <input type="password" id="pin-qr" class="swal2-input" placeholder="Introduce el PIN" autocomplete="off">
        `,
        confirmButtonText: 'Acceder',
        confirmButtonColor: '#9333ea',
        showCancelButton: true,
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
          return document.getElementById('pin-qr').value;
        }
      });

      if (pin === pinCorrecto) {
        renderVistaQR();
      } else if (pin) {
        Swal.fire({
          icon: 'error',
          title: 'PIN incorrecto',
          text: 'Acceso denegado'
        });
      }
    }

    async function renderVistaQR() {
      const app = document.getElementById('app');

      // Obtener configuraci√≥n para saber la duraci√≥n del QR
      const configRes = await fetch('/api/config');
      const config = await configRes.json();
      const duracion = config.qr_duracion || 60;

      app.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-purple-600 via-fuchsia-600 to-purple-700 flex flex-col items-center justify-center p-4">
          <!-- Bot√≥n salir (esquina superior derecha) -->
          <button onclick="volverAlLogin()" class="absolute top-4 right-4 bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold py-2 px-4 rounded-lg transition backdrop-blur-sm">
            ‚Üê Volver
          </button>
          
          <div class="text-center">
            <h1 class="text-5xl font-bold text-white mb-2">üì± C√≥digo QR de Fichaje</h1>
            <p class="text-purple-100 text-lg mb-8">Escanea este c√≥digo para registrar entrada/salida</p>
            
            <!-- QR Display -->
            <div class="bg-white rounded-3xl p-10 shadow-2xl inline-block">
              <img id="qr-code-display" src="" alt="QR Code" class="w-96 h-96 mx-auto rounded-xl">
            </div>
            
            <!-- Informaci√≥n de actualizaci√≥n -->
            <div class="mt-8 bg-purple-800 bg-opacity-50 backdrop-blur-lg rounded-2xl p-6 max-w-md mx-auto">
              <p class="text-white text-xl font-bold mb-3">üîÑ C√≥digo se renueva autom√°ticamente</p>
              <p class="text-purple-100 text-lg mb-4">Cada <span id="qr-duration-display" class="font-bold text-2xl text-white">${duracion}</span> segundos</p>
              <div class="bg-purple-900 bg-opacity-60 rounded-full h-4 overflow-hidden">
                <div id="qr-progress-display" class="bg-gradient-to-r from-white to-purple-200 h-full transition-all" style="width: 100%"></div>
              </div>
            </div>
            
            <p class="text-purple-100 text-sm mt-6 opacity-80 max-w-lg mx-auto">
              üí° Los empleados pueden escanear este c√≥digo con su m√≥vil para registrar su fichaje sin necesidad de GPS
            </p>
          </div>
        </div>
      `;

      // Iniciar auto-refresh del QR
      iniciarQRVistaIndependiente(duracion);
    }

    let qrVistaInterval = null;
    let qrVistaProgressInterval = null;

    function iniciarQRVistaIndependiente(duracion) {
      // Generar QR inmediatamente
      actualizarQRVista();

      // Actualizar cada X segundos
      const duracionMs = duracion * 1000;

      if (qrVistaInterval) clearInterval(qrVistaInterval);
      if (qrVistaProgressInterval) clearInterval(qrVistaProgressInterval);

      qrVistaInterval = setInterval(actualizarQRVista, duracionMs);
    }

    async function actualizarQRVista() {
      try {
        const response = await fetch('/api/qr/current');
        const contentType = response.headers.get('content-type') || '';
        const isJson = contentType.includes('application/json');
        const data = isJson ? await response.json() : null;

        if (!response.ok) {
          const msg = data?.error || `Error obteniendo QR (${response.status})`;
          console.error('Error actualizando QR:', msg);
          // Si la empresa est√° desactivada o no autorizada, salir del modo QR
          if (response.status === 403) {
            Swal.fire('Empresa desactivada', msg, 'warning');
            volverAlLogin();
          }
          return;
        }

        if (!data) {
          throw new Error('Respuesta no es JSON');
        }

        if (response.ok) {
          // Actualizar imagen del QR
          document.getElementById('qr-code-display').src = data.qrDataURL;
          document.getElementById('qr-duration-display').textContent = data.expiraEn;

          // Iniciar barra de progreso
          const progressBar = document.getElementById('qr-progress-display');
          const duration = data.expiraEn * 1000;
          let elapsed = 0;

          if (qrVistaProgressInterval) clearInterval(qrVistaProgressInterval);

          qrVistaProgressInterval = setInterval(() => {
            elapsed += 100;
            const percentage = Math.max(0, 100 - (elapsed / duration * 100));
            progressBar.style.width = percentage + '%';

            if (elapsed >= duration) {
              clearInterval(qrVistaProgressInterval);
              progressBar.style.width = '100%';
            }
          }, 100);
        }
      } catch (error) {
        console.error('Error actualizando QR:', error);
      }
    }

    function volverAlLogin() {
      // Detener intervalos
      if (qrVistaInterval) clearInterval(qrVistaInterval);
      if (qrVistaProgressInterval) clearInterval(qrVistaProgressInterval);

      // Volver al login
      currentUser = null;
      renderLogin();
    }

    async function renderEmployee() {
      // Obtener configuraci√≥n del m√©todo de fichaje
      const configRes = await fetch('/api/config');
      const config = await configRes.json();
      const metodo = config.metodo_fichaje || 'gps';

      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-slate-100 to-slate-200 p-4">
          <div class="max-w-4xl mx-auto">
            <!-- Tarjeta principal -->
            <div class="bg-white rounded-lg shadow-xl p-8 text-center mb-4 border-2 border-slate-200">
              <h1 class="text-3xl font-bold text-slate-800 mb-2">Bienvenido</h1>
              <p class="text-2xl text-cyan-600 font-bold mb-8">${currentUser.nombre}</p>
              
              ${metodo === 'gps' ? `
                <!-- Modo GPS -->
                <div class="grid md:grid-cols-2 gap-3 mb-4">
                  <button onclick="checkIn('ENTRADA')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-6 text-2xl rounded-lg transition duration-200 shadow-lg">
                    üìç FICHAR ENTRADA
                  </button>

                  <button onclick="checkIn('SALIDA')" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-6 text-2xl rounded-lg transition duration-200 shadow-lg">
                    üö™ FICHAR SALIDA
                  </button>
                </div>
              ` : metodo === 'qr' ? `
                <!-- Modo QR -->
                <div class="grid md:grid-cols-2 gap-3 mb-4">
                  <button onclick="escanearQR('ENTRADA')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-6 text-2xl rounded-lg transition duration-200 shadow-lg">
                    üì± ESCANEAR ENTRADA
                  </button>

                  <button onclick="escanearQR('SALIDA')" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-6 text-2xl rounded-lg transition duration-200 shadow-lg">
                    üì± ESCANEAR SALIDA
                  </button>
                </div>
              ` : `
                <!-- Modo Ambos - Empleado elige -->
                <div class="mb-4">
                  <p class="text-sm font-semibold text-slate-600 mb-2">Elige tu m√©todo de fichaje:</p>
                  <div class="grid md:grid-cols-2 gap-2 mb-3">
                    <button onclick="setMetodoEmpleado('gps')" id="btn-metodo-gps" class="bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition">
                      üìç GPS
                    </button>
                    <button onclick="setMetodoEmpleado('qr')" id="btn-metodo-qr" class="bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition">
                      üì± QR
                    </button>
                  </div>
                </div>
                
                <div id="fichaje-gps-section" class="grid md:grid-cols-2 gap-3 mb-4">
                  <button onclick="checkIn('ENTRADA')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-6 text-2xl rounded-lg transition duration-200 shadow-lg">
                    üìç FICHAR ENTRADA
                  </button>

                  <button onclick="checkIn('SALIDA')" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-6 text-2xl rounded-lg transition duration-200 shadow-lg">
                    üö™ FICHAR SALIDA
                  </button>
                </div>
                
                <div id="fichaje-qr-section" class="hidden grid md:grid-cols-2 gap-3 mb-4">
                  <button onclick="escanearQR('ENTRADA')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-6 text-2xl rounded-lg transition duration-200 shadow-lg">
                    üì± ESCANEAR ENTRADA
                  </button>

                  <button onclick="escanearQR('SALIDA')" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-6 text-2xl rounded-lg transition duration-200 shadow-lg">
                    üì± ESCANEAR SALIDA
                  </button>
                </div>
              `}

              <button onclick="showHorarios()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-lg transition duration-200 mb-3">
                üìÖ Ver Mi Horario
              </button>
              
              <button onclick="logout()" class="w-full bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 rounded-lg transition duration-200">
                Cerrar Sesi√≥n
              </button>
            </div>

            <!-- Horarios del empleado -->
            <div id="employee-schedule" class="bg-white rounded-lg shadow-xl p-6 border-2 border-slate-200">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-800">üìÖ Mi Horario</h2>
                <select id="employee-view" onchange="showHorarios()" class="px-4 py-2 border-2 border-cyan-500 rounded-lg font-semibold bg-white text-cyan-600 hover:bg-cyan-50 transition cursor-pointer">
                  <option value="week">üìÖ Semanal</option>
                  <option value="month">üìÜ Mensual</option>
                  <option value="quarter">üìä Trimestral</option>
                </select>
              </div>
              
              <!-- Estad√≠sticas -->
              <div id="schedule-stats" class="hidden grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                <div class="bg-gradient-to-br from-cyan-50 to-cyan-100 border-2 border-cyan-300 rounded-lg p-4 text-center">
                  <div class="text-2xl font-bold text-cyan-600" id="stat-hours-week">0h</div>
                  <div class="text-xs text-slate-600 font-semibold">Horas Semana</div>
                </div>
                <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 border-2 border-emerald-300 rounded-lg p-4 text-center">
                  <div class="text-2xl font-bold text-emerald-600" id="stat-hours-month">0h</div>
                  <div class="text-xs text-slate-600 font-semibold">Horas Mes</div>
                </div>
                <div class="bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-300 rounded-lg p-4 text-center">
                  <div class="text-2xl font-bold text-orange-600" id="stat-days-worked">0</div>
                  <div class="text-xs text-slate-600 font-semibold">D√≠as Trabajados</div>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-300 rounded-lg p-4 text-center">
                  <div class="text-2xl font-bold text-purple-600" id="stat-days-free">0</div>
                  <div class="text-xs text-slate-600 font-semibold">D√≠as Libres</div>
                </div>
              </div>
              
              <!-- Toolbar: Filtros y opciones -->
              <div class="bg-slate-50 rounded-lg p-4 mb-4 border-2 border-slate-200">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                  <!-- Filtro de fecha inicio -->
                  <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1">üìÖ Desde</label>
                    <input type="date" id="filter-date-from" onchange="showHorarios()" class="w-full px-3 py-2 border-2 border-slate-300 rounded-lg text-sm focus:border-cyan-500 focus:outline-none">
                  </div>
                  
                  <!-- Filtro de fecha fin -->
                  <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1">üìÖ Hasta</label>
                    <input type="date" id="filter-date-to" onchange="showHorarios()" class="w-full px-3 py-2 border-2 border-slate-300 rounded-lg text-sm focus:border-cyan-500 focus:outline-none">
                  </div>
                  
                  <!-- Botones de acci√≥n -->
                  <div class="flex gap-2">
                    <button onclick="toggleCompactMode()" id="btn-compact" class="flex-1 bg-slate-600 hover:bg-slate-700 text-white px-3 py-2 rounded-lg text-sm font-semibold transition" title="Modo compacto">
                      üì± Compacto
                    </button>
                    <button onclick="toggleStats()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg text-sm font-semibold transition" title="Mostrar estad√≠sticas">
                      üìä Stats
                    </button>
                  </div>
                  
                  <button onclick="exportSchedule()" class="bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-md hover:shadow-lg">
                    üíæ Exportar PDF
                  </button>
                </div>
              </div>
              
              <div id="schedule-content" class="text-center text-gray-500">
                Click en "Ver Mi Horario" para cargar tu horario
              </div>
            </div>

            <div id="status" class="text-white text-center text-sm mt-4"></div>
          </div>
        </div>
      `;
    }

    let compactMode = false;

    function toggleCompactMode() {
      compactMode = !compactMode;
      const btn = document.getElementById('btn-compact');
      btn.classList.toggle('bg-cyan-600');
      btn.classList.toggle('bg-slate-600');
      showHorarios();
    }

    function toggleStats() {
      const stats = document.getElementById('schedule-stats');
      stats.classList.toggle('hidden');
      stats.classList.toggle('grid');
    }

    async function showHorarios() {
      const scheduleContent = document.getElementById('schedule-content');
      const viewSelect = document.getElementById('employee-view');
      const view = viewSelect ? viewSelect.value : 'week';

      // Obtener filtros de fecha
      const dateFrom = document.getElementById('filter-date-from')?.value;
      const dateTo = document.getElementById('filter-date-to')?.value;

      scheduleContent.innerHTML = '<div class="flex justify-center"><div class="spinner" style="border-color: #3b82f6; border-top-color: transparent;"></div></div>';

      try {
        // Solicitar horarios expandidos para manejar recurrencias correctamente
        const response = await fetch(`/api/horarios?userId=${currentUser.id}&expandir=true`);
        let horarios = await response.json();

        if (horarios.length === 0) {
          scheduleContent.innerHTML = '<p class="text-gray-500">No tienes horarios asignados todav√≠a</p>';
          return;
        }

        // Aplicar filtros de fecha si existen
        if (dateFrom || dateTo) {
          horarios = horarios.filter(h => {
            // Crear fecha aproximada del horario basada en d√≠a de la semana
            const today = new Date();
            const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const diaIndex = diasSemana.indexOf(h.dia_semana);
            const currentDay = today.getDay();
            const diff = diaIndex - currentDay;
            const horarioDate = new Date(today);
            horarioDate.setDate(today.getDate() + diff);
            const horarioDateStr = horarioDate.toISOString().split('T')[0];

            if (dateFrom && dateTo) {
              return horarioDateStr >= dateFrom && horarioDateStr <= dateTo;
            } else if (dateFrom) {
              return horarioDateStr >= dateFrom;
            } else if (dateTo) {
              return horarioDateStr <= dateTo;
            }
            return true;
          });
        }

        // Calcular estad√≠sticas
        calculateStats(horarios);

        const diasOrden = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

        if (view === 'week') {
          // Vista semanal
          const horariosPorDia = {};
          diasOrden.forEach(dia => horariosPorDia[dia] = []);
          horarios.forEach(h => {
            if (horariosPorDia[h.dia_semana]) {
              horariosPorDia[h.dia_semana].push(h);
            }
          });

          scheduleContent.innerHTML = `
            <div class="bg-white rounded-xl ${compactMode ? 'p-3' : 'p-6'} shadow-xl border-2 border-slate-200">
              <div class="grid grid-cols-1 md:grid-cols-7 gap-3">
                ${diasOrden.map(dia => {
            const horariosDelDia = horariosPorDia[dia];
            const tieneHorarios = horariosDelDia.length > 0;

            return `
                    <div class="bg-white rounded-lg overflow-hidden border-2 ${tieneHorarios ? 'border-cyan-500' : 'border-slate-200'} shadow-md hover:shadow-lg transition-all duration-300">
                      <div class="bg-gradient-to-r ${tieneHorarios ? 'from-cyan-600 to-cyan-700' : 'from-slate-600 to-slate-700'} text-white text-center ${compactMode ? 'py-2' : 'py-3'} font-bold ${compactMode ? 'text-xs' : 'text-sm'}">
                        ${dia.substring(0, 3).toUpperCase()}
                      </div>
                      <div class="${compactMode ? 'p-2' : 'p-3'} ${compactMode ? 'min-h-[80px]' : 'min-h-[140px]'} bg-slate-50">
                        ${tieneHorarios ? horariosDelDia.map(h => `
                          <div class="mb-2 ${compactMode ? 'p-2' : 'p-3'} bg-white rounded-lg border-2 border-cyan-200 hover:border-cyan-400 transition-all duration-200 shadow-sm">
                            ${!compactMode ? '<div class="flex items-center justify-center mb-2"><span class="text-2xl">‚è∞</span></div>' : ''}
                            <div class="text-center">
                              <p class="${compactMode ? 'text-sm' : 'text-xl'} font-bold text-cyan-600">${h.hora_inicio}</p>
                              <p class="text-xs text-slate-400 my-1">‚Üì</p>
                              <p class="${compactMode ? 'text-sm' : 'text-xl'} font-bold text-cyan-600">${h.hora_fin}</p>
                            </div>
                            ${!compactMode && h.notas ? `<p class="text-xs text-slate-600 mt-2 text-center italic border-t border-slate-200 pt-2">${h.notas}</p>` : ''}
                          </div>
                        `).join('') : `
                          <div class="flex items-center justify-center h-full">
                            <div class="text-center text-slate-400">
                              <p class="${compactMode ? 'text-2xl' : 'text-4xl'} mb-2">üö´</p>
                              ${!compactMode ? '<p class="text-xs uppercase tracking-wider font-semibold">Libre</p>' : ''}
                            </div>
                          </div>
                        `}
                      </div>
                    </div>
                  `;
          }).join('')}
              </div>
            </div>
          `;
        } else if (view === 'month') {
          // Vista mensual (30 d√≠as) - MEJORADA
          const days = 30;
          const today = new Date();
          const mesesNombres = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

          // Agrupar d√≠as por mes
          const diasPorMes = {};
          for (let i = 0; i < days; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() + i);
            const mesKey = `${date.getFullYear()}-${date.getMonth()}`;
            const mesNombre = mesesNombres[date.getMonth()];

            if (!diasPorMes[mesKey]) {
              diasPorMes[mesKey] = { nombre: mesNombre, dias: [], year: date.getFullYear() };
            }
            diasPorMes[mesKey].dias.push({ date, index: i });
          }

          scheduleContent.innerHTML = `
            <div class="bg-white rounded-xl ${compactMode ? 'p-3' : 'p-6'} shadow-xl border-2 border-slate-200">
              ${Object.entries(diasPorMes).map(([key, mesData]) => `
                <div class="${compactMode ? 'mb-4' : 'mb-8'}">
                  <!-- Header del mes -->
                  <div class="bg-gradient-to-r from-cyan-600 to-cyan-700 border-l-4 border-cyan-800 text-white ${compactMode ? 'px-4 py-2' : 'px-6 py-4'} rounded-lg shadow-lg ${compactMode ? 'mb-2' : 'mb-4'}">
                    <div class="flex justify-between items-center">
                      <h3 class="${compactMode ? 'text-lg' : 'text-2xl'} font-bold">üìÖ ${mesData.nombre.toUpperCase()} ${mesData.year}</h3>
                      <span class="bg-white text-cyan-700 ${compactMode ? 'px-2 py-0.5' : 'px-4 py-1'} rounded-full ${compactMode ? 'text-xs' : 'text-sm'} font-bold">
                        ${mesData.dias.length} d√≠as
                      </span>
                    </div>
                  </div>
                  
                  <!-- D√≠as del mes -->
                  <div class="bg-slate-50 rounded-lg shadow-lg ${compactMode ? 'p-2' : 'p-4'} border-2 border-slate-200">
                    <div class="grid grid-cols-7 ${compactMode ? 'gap-1' : 'gap-3'}">
                      ${mesData.dias.map(({ date, index }) => {
            const dayName = diasOrden[date.getDay() === 0 ? 6 : date.getDay() - 1];
            const dayNum = date.getDate();
            const isToday = date.toDateString() === new Date().toDateString();
            const dateStr = date.toISOString().split('T')[0];

            // Filtrar horarios para este d√≠a espec√≠fico
            const horariosDelDia = horarios.filter(h => {
              // Si el horario tiene fechas espec√≠ficas, verificar si la fecha actual est√° en el rango
              if (h.fecha_desde && h.fecha_hasta) {
                return h.dia_semana === dayName && dateStr >= h.fecha_desde && dateStr <= h.fecha_hasta;
              }
              // Si no tiene fechas, es un horario recurrente (aplica siempre)
              return h.dia_semana === dayName;
            });

            const tieneHorarios = horariosDelDia.length > 0;

            return `
                          <div class="rounded-lg overflow-hidden border-2 ${isToday ? 'border-emerald-500 ring-2 ring-emerald-300' : tieneHorarios ? 'border-cyan-400' : 'border-slate-300'} bg-white shadow-sm hover:shadow-md transition-all">
                            <div class="bg-gradient-to-r ${isToday ? 'from-emerald-600 to-emerald-700' : tieneHorarios ? 'from-cyan-600 to-cyan-700' : 'from-slate-500 to-slate-600'} text-white text-center ${compactMode ? 'py-1' : 'py-2'}">
                              ${!compactMode ? `<p class="text-xs font-semibold">${dayName.substring(0, 3)}</p>` : ''}
                              <p class="${compactMode ? 'text-sm' : 'text-lg'} font-bold">${dayNum}</p>
                            </div>
                            <div class="${compactMode ? 'p-1' : 'p-2'} ${compactMode ? 'min-h-[60px]' : 'min-h-[90px]'} bg-slate-50">
                              ${tieneHorarios ? horariosDelDia.map((h, idx) => `
                                <div class="mb-1 ${compactMode ? 'p-1' : 'p-2'} bg-white rounded-lg border border-cyan-300">
                                  ${!compactMode && idx === 0 ? '<p class="text-xs text-slate-600 mb-1">üïê Turno ' + (horariosDelDia.length > 1 ? '1' : '') + '</p>' : !compactMode ? '<p class="text-xs text-orange-600 mb-1">üîÑ Turno 2</p>' : ''}
                                  <div class="text-center">
                                    <p class="${compactMode ? 'text-xs' : 'text-sm'} font-bold text-cyan-600">${h.hora_inicio}</p>
                                    ${!compactMode ? '<p class="text-xs text-slate-400">‚¨á</p>' : ''}
                                    <p class="${compactMode ? 'text-xs' : 'text-sm'} font-bold text-cyan-600">${h.hora_fin}</p>
                                  </div>
                                  ${!compactMode && h.notas ? `<p class="text-xs text-slate-600 mt-1 italic text-center">${h.notas}</p>` : ''}
                                </div>
                              `).join('') : `
                                <div class="flex flex-col items-center justify-center h-full text-slate-400">
                                  <p class="${compactMode ? 'text-xl' : 'text-3xl'} mb-1">üèùÔ∏è</p>
                                  ${!compactMode ? '<p class="text-xs font-semibold">Libre</p>' : ''}
                                </div>
                              `}
                            </div>
                          </div>
                        `;
          }).join('')}
                    </div>
                  </div>
                </div>
              `).join('')}
              
              <!-- Leyenda -->
              <div class="mt-4 bg-slate-100 p-6 rounded-lg shadow-lg border-2 border-slate-200">
                <h4 class="font-bold text-slate-700 mb-3">üìñ Leyenda:</h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                  <div class="flex items-center gap-2 text-slate-700">
                    <div class="w-4 h-4 bg-emerald-500 rounded"></div>
                    <span class="font-semibold">Hoy</span>
                  </div>
                  <div class="flex items-center gap-2 text-slate-700">
                    <div class="w-4 h-4 bg-cyan-500 rounded"></div>
                    <span class="font-semibold">Con horario</span>
                  </div>
                  <div class="flex items-center gap-2 text-slate-700">
                    <span class="text-lg">üîÑ</span>
                    <span class="font-semibold">Doble turno</span>
                  </div>
                  <div class="flex items-center gap-2 text-slate-700">
                    <span class="text-lg">üèùÔ∏è</span>
                    <span class="font-semibold">D√≠a libre</span>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else if (view === 'quarter') {
          // Vista trimestral (90 d√≠as) - MEJORADA CON MESES
          const days = 90;
          const today = new Date();
          const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
          const mesesCortos = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

          // Agrupar d√≠as por mes
          const diasPorMes = {};
          for (let i = 0; i < days; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() + i);
            const mesKey = `${date.getFullYear()}-${date.getMonth()}`;
            const mesNombre = mesesNombres[date.getMonth()];
            const mesCorto = mesesCortos[date.getMonth()];

            if (!diasPorMes[mesKey]) {
              diasPorMes[mesKey] = {
                nombre: mesNombre,
                corto: mesCorto,
                dias: [],
                year: date.getFullYear(),
                mes: date.getMonth()
              };
            }
            diasPorMes[mesKey].dias.push({ date, index: i });
          }

          // Colores profesionales por mes - sin pasteles
          const coloresMes = [
            'from-cyan-600 to-cyan-700',
            'from-blue-600 to-blue-700',
            'from-indigo-600 to-indigo-700',
            'from-violet-600 to-violet-700',
            'from-purple-600 to-purple-700',
            'from-fuchsia-600 to-fuchsia-700',
            'from-pink-600 to-pink-700',
            'from-rose-600 to-rose-700',
            'from-red-600 to-red-700',
            'from-orange-600 to-orange-700',
            'from-amber-600 to-amber-700',
            'from-emerald-600 to-emerald-700'
          ];

          scheduleContent.innerHTML = `
            <div class="bg-white rounded-xl ${compactMode ? 'p-3' : 'p-6'} max-h-[75vh] overflow-y-auto border-2 border-slate-200 shadow-xl">
              ${Object.entries(diasPorMes).map(([key, mesData], mesIndex) => `
                <div class="${compactMode ? 'mb-3' : 'mb-6'}">
                  <!-- Header del mes con color √∫nico -->
                  <div class="bg-gradient-to-r ${coloresMes[mesData.mes % 12]} text-white ${compactMode ? 'px-4 py-2' : 'px-6 py-4'} rounded-lg shadow-lg border-l-4 border-white ${compactMode ? 'mb-2' : 'mb-3'}">
                    <div class="flex justify-between items-center">
                      <h3 class="${compactMode ? 'text-lg' : 'text-2xl'} font-bold">üìÖ ${mesData.nombre} ${mesData.year}</h3>
                      <span class="bg-white bg-opacity-30 ${compactMode ? 'px-2 py-1' : 'px-4 py-2'} rounded-full ${compactMode ? 'text-xs' : 'text-sm'} font-bold">
                        ${mesData.dias.length} d√≠as
                      </span>
                    </div>
                  </div>
                  
                  <!-- Grid de d√≠as del mes -->
                  <div class="bg-slate-50 rounded-lg shadow-lg border-2 border-slate-200 ${compactMode ? 'p-2' : 'p-4'} ${compactMode ? 'mb-2' : 'mb-4'}">
                    <div class="grid grid-cols-7 md:grid-cols-10 ${compactMode ? 'gap-1' : 'gap-2'}">
                      ${mesData.dias.map(({ date, index }) => {
            const dayName = diasOrden[date.getDay() === 0 ? 6 : date.getDay() - 1];
            const dayNum = date.getDate();
            const isToday = date.toDateString() === new Date().toDateString();
            const dateStr = date.toISOString().split('T')[0];

            // Filtrar horarios para este d√≠a espec√≠fico considerando fechas
            const horariosDelDia = horarios.filter(h => {
              if (h.fecha_desde && h.fecha_hasta) {
                return h.dia_semana === dayName && dateStr >= h.fecha_desde && dateStr <= h.fecha_hasta;
              }
              return h.dia_semana === dayName;
            });

            const tieneHorarios = horariosDelDia.length > 0;

            return `
                          <div class="rounded-lg overflow-hidden border-2 ${isToday ? 'border-emerald-500 ring-2 ring-emerald-300' : tieneHorarios ? 'border-cyan-400' : 'border-slate-300'} bg-white shadow hover:shadow-md transition-all ${!compactMode ? 'transform hover:scale-105' : ''}">
                            <div class="bg-gradient-to-br ${isToday ? 'from-emerald-600 to-emerald-700' : tieneHorarios ? coloresMes[mesData.mes % 12] : 'from-slate-500 to-slate-600'} text-white text-center ${compactMode ? 'py-1' : 'py-2'}">
                              ${!compactMode ? `<p class="text-xs font-bold">${dayName.substring(0, 1)}</p>` : ''}
                              <p class="${compactMode ? 'text-sm' : 'text-lg'} font-bold">${dayNum}</p>
                              ${!compactMode ? `<p class="text-xs opacity-80">${mesData.corto}</p>` : ''}
                            </div>
                            <div class="${compactMode ? 'p-1' : 'p-2'} ${compactMode ? 'min-h-[50px]' : 'min-h-[70px]'} flex flex-col justify-center bg-slate-50">
                              ${tieneHorarios ? `
                                <div class="text-center">
                                  <p class="${compactMode ? 'text-xs' : 'text-xs'} font-bold text-cyan-600">${horariosDelDia[0].hora_inicio.substring(0, 5)}</p>
                                  ${!compactMode ? '<p class="text-xs text-slate-400">‚¨á</p>' : ''}
                                  <p class="${compactMode ? 'text-xs' : 'text-xs'} font-bold text-cyan-600">${horariosDelDia[0].hora_fin.substring(0, 5)}</p>
                                  ${horariosDelDia.length > 1 && !compactMode ? `<p class="text-xs text-orange-600 font-bold mt-1">üîÑ x${horariosDelDia.length}</p>` : ''}
                                </div>
                              ` : `
                                <p class="text-center text-slate-400 ${compactMode ? 'text-lg' : 'text-2xl'}">üèùÔ∏è</p>
                              `}
                            </div>
                          </div>
                        `;
          }).join('')}
                    </div>
                  </div>
                </div>
              `).join('')}
              
              <!-- Leyenda mejorada -->
              <div class="bg-slate-100 p-6 rounded-lg shadow border-2 border-slate-200 sticky bottom-0">
                <h4 class="font-bold text-slate-700 mb-4 text-lg">üìñ Leyenda</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                  <div class="flex items-center gap-2 bg-white p-3 rounded border-2 border-emerald-400 shadow-sm">
                    <div class="w-4 h-4 bg-emerald-500 rounded-full"></div>
                    <span class="font-semibold text-slate-700">Hoy</span>
                  </div>
                  <div class="flex items-center gap-2 bg-white p-3 rounded border-2 border-cyan-400 shadow-sm">
                    <div class="w-4 h-4 bg-cyan-500 rounded-full"></div>
                    <span class="font-semibold text-slate-700">Con horario</span>
                  </div>
                  <div class="flex items-center gap-2 bg-white p-3 rounded border-2 border-orange-400 shadow-sm">
                    <span class="text-lg">üîÑ</span>
                    <span class="font-semibold text-slate-700">Doble turno</span>
                  </div>
                  <div class="flex items-center gap-2 bg-white p-3 rounded border-2 border-slate-300 shadow-sm">
                    <span class="text-lg">üèùÔ∏è</span>
                    <span class="font-semibold text-slate-700">D√≠a libre</span>
                  </div>
                </div>
              </div>
            </div>
          `;
        }
      } catch (error) {
        scheduleContent.innerHTML = '<p class="text-red-500">Error al cargar horarios</p>';
      }
    }

    async function checkIn(tipo = 'ENTRADA') {
      // Verificar que el usuario est√© logeado
      if (!currentUser || !currentUser.id) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Debes estar logeado para fichar',
          confirmButtonColor: '#dc2626'
        });
        return;
      }

      // Verificar √∫ltimo fichaje antes de proceder
      try {
        const lastLogRes = await fetch(`/api/last-log/${currentUser.id}`);
        const lastLog = await lastLogRes.json();

        if (lastLog) {
          if (lastLog.tipo === 'ENTRADA' && tipo === 'ENTRADA') {
            Swal.fire({
              icon: 'warning',
              title: 'Ya fichaste la entrada',
              text: 'Debes fichar la salida ahora',
              confirmButtonColor: '#f97316'
            });
            return;
          }
          if (lastLog.tipo === 'SALIDA' && tipo === 'SALIDA') {
            Swal.fire({
              icon: 'warning',
              title: 'Ya fichaste la salida',
              text: 'Debes fichar la entrada ahora',
              confirmButtonColor: '#16a34a'
            });
            return;
          }
        }
      } catch (error) {
        console.error('Error verificando √∫ltimo fichaje:', error);
      }

      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = '<div class="flex justify-center"><div class="spinner"></div></div>';

      if (!navigator.geolocation) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Tu navegador no soporta geolocalizaci√≥n'
        });
        statusDiv.innerHTML = '';
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const { latitude, longitude } = position.coords;
          console.log('DEBUG checkIn:', { userId: currentUser.id, lat: latitude, lon: longitude, tipo });

          // Cargar config para saber si se requiere foto
          let requirePhoto = false;
          try {
            const configRes = await fetch('/api/config');
            const config = await configRes.json();
            requirePhoto = config.require_photo === true;
            console.log('DEBUG: Config require_photo:', requirePhoto);
          } catch (e) {
            console.error('Error loading config:', e);
          }

          // Si requiere foto, mostrar c√°mara primero
          let photoFile = null;
          if (requirePhoto) {
            photoFile = await capturePhotoModal();
            if (!photoFile) {
              statusDiv.innerHTML = '';
              return; // Usuario cancel√≥
            }
          }

          try {
            // Enviar como FormData si hay foto, sino como JSON
            let fetchOptions = {
              method: 'POST'
            };

            if (photoFile) {
              const formData = new FormData();
              formData.append('userId', currentUser.id);
              formData.append('lat', latitude);
              formData.append('lon', longitude);
              formData.append('tipo', tipo);
              formData.append('photo', photoFile);
              fetchOptions.body = formData;
              // No establecer Content-Type, el navegador lo har√° autom√°ticamente
            } else {
              fetchOptions.headers = { 'Content-Type': 'application/json' };
              fetchOptions.body = JSON.stringify({
                userId: currentUser.id,
                lat: latitude,
                lon: longitude,
                tipo: tipo
              });
            }

            const response = await fetch('/api/check-in', fetchOptions);
            const data = await response.json();
            console.log('DEBUG checkIn response:', { status: response.status, data });

            statusDiv.innerHTML = '';

            if (response.ok) {
              Swal.fire({
                icon: 'success',
                title: '¬°Excelente!',
                html: `<strong>${data.tipo}</strong> registrada<br>Distancia: ${data.distance || 0}m`,
                confirmButtonColor: tipo === 'ENTRADA' ? '#16a34a' : '#f97316'
              });
            } else {
              const distanceText = data.distance ? `Est√°s a ${data.distance}m. M√°ximo permitido: ${data.maxDistance || 50}m` : data.error;
              Swal.fire({
                icon: 'error',
                title: 'Error al fichar',
                text: distanceText,
                confirmButtonColor: '#dc2626'
              });
            }
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'No se pudo registrar el fichaje'
            });
          }

          statusDiv.innerHTML = '';
        },
        (error) => {
          Swal.fire({
            icon: 'error',
            title: 'Error de Geolocalizaci√≥n',
            text: error.message
          });
          statusDiv.innerHTML = '';
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    async function capturePhotoModal() {
      return new Promise((resolve) => {
        Swal.fire({
          title: 'üì∑ Capturar Foto',
          html: `
            <div class="flex flex-col gap-3 items-center">
              <p class="text-sm text-slate-600 mb-2">Se requiere una foto para validar tu fichaje</p>
              <video id="cameraVideo" width="300" height="300" style="border: 2px solid #0891b2; border-radius: 8px; object-fit: cover; display: none;"></video>
              <canvas id="photoCanvas" width="300" height="300" style="border: 2px solid #0891b2; border-radius: 8px; display: none;"></canvas>
              <img id="photoPreview" style="max-width: 300px; border: 2px solid #0891b2; border-radius: 8px; display: none;">
              <div id="cameraControls" class="flex gap-2 justify-center">
                <button id="startCameraBtn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded">Abrir C√°mara</button>
              </div>
              <div id="photoControls" style="display: none;" class="flex gap-2 justify-center">
                <button id="capturePhotoBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Capturar Foto</button>
                <button id="retakPhotoBtn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded">Reintentar</button>
              </div>
            </div>
          `,
          showCancelButton: true,
          showConfirmButton: false,
          didOpen: async () => {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('photoCanvas');
            const photoPreview = document.getElementById('photoPreview');
            const cameraControls = document.getElementById('cameraControls');
            const photoControls = document.getElementById('photoControls');
            const startCameraBtn = document.getElementById('startCameraBtn');
            const capturePhotoBtn = document.getElementById('capturePhotoBtn');
            const retakPhotoBtn = document.getElementById('retakPhotoBtn');
            // Bot√≥n de cambiar c√°mara
            const switchBtn = document.createElement('button');
            switchBtn.textContent = 'Cambiar c√°mara';
            switchBtn.className = 'bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded';
            switchBtn.style.display = 'none';
            cameraControls.appendChild(switchBtn);
            let stream = null;
            let photoBlob = null;
            let facingMode = 'user';

            async function startStreamWithFallback() {
              let lastError = null;
              const constraintsList = [
                { video: { facingMode, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false },
                { video: { facingMode }, audio: false },
                { video: true, audio: false }
              ];

              for (const constraints of constraintsList) {
                try {
                  const s = await navigator.mediaDevices.getUserMedia(constraints);
                  return s;
                } catch (err) {
                  lastError = err;
                }
              }
              throw lastError || new Error('No se pudo acceder a la c√°mara');
            }

            startCameraBtn.addEventListener('click', async () => {
              try {
                if (stream) {
                  stream.getTracks().forEach(t => t.stop());
                }

                stream = await startStreamWithFallback();
                video.srcObject = stream;
                video.setAttribute('playsinline', 'true'); // necesario en iOS para no ir a fullscreen

                await Promise.race([
                  new Promise((resolve, reject) => {
                    const to = setTimeout(() => reject(new Error('Timeout iniciando c√°mara')), 4000);
                    video.onloadedmetadata = () => { clearTimeout(to); resolve(); };
                  }),
                  video.play()
                ]);

                if (video.videoWidth === 0 || video.videoHeight === 0) {
                  throw new Error('La c√°mara tard√≥ demasiado en iniciar. Intenta de nuevo.');
                }

                video.style.display = 'block';
                cameraControls.style.display = 'none';
                photoControls.style.display = 'flex';
                switchBtn.style.display = 'inline-flex';
              } catch (err) {
                Swal.showValidationMessage('No se pudo acceder a la c√°mara: ' + err.message);
              }
            });

            switchBtn.addEventListener('click', async () => {
              facingMode = facingMode === 'user' ? 'environment' : 'user';
              startCameraBtn.click();
            });

            capturePhotoBtn.addEventListener('click', () => {
              if (!stream) {
                Swal.showValidationMessage('La c√°mara no est√° lista. Pulsa "Abrir C√°mara" de nuevo.');
                return;
              }
              const ctx = canvas.getContext('2d');
              const w = video.videoWidth || 300;
              const h = video.videoHeight || 300;
              canvas.width = w;
              canvas.height = h;
              // Para c√°mara frontal, espejar para que no se vea invertido
              if (facingMode === 'user') {
                ctx.save();
                ctx.translate(w, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, w, h);
                ctx.restore();
              } else {
                ctx.drawImage(video, 0, 0, w, h);
              }
              canvas.toBlob((blob) => {
                photoBlob = blob;
                photoPreview.src = URL.createObjectURL(blob);
                photoPreview.style.display = 'block';
                video.style.display = 'none';
                photoControls.style.display = 'none';
                
                // Mostrar bot√≥n de confirmaci√≥n
                Swal.fire({
                  title: '‚úÖ Foto Capturada',
                  imageUrl: URL.createObjectURL(blob),
                  imageWidth: 300,
                  imageHeight: 300,
                  html: '<p class="text-sm text-slate-600 mt-3">¬øEst√° bien la foto?</p>',
                  showCancelButton: true,
                  cancelButtonText: 'Reintentar',
                  confirmButtonText: 'Confirmar',
                  confirmButtonColor: '#16a34a',
                  cancelButtonColor: '#f97316'
                }).then((result) => {
                  if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                  }
                  if (result.isConfirmed) {
                    resolve(photoBlob);
                  } else {
                    resolve(null);
                  }
                });
              }, 'image/jpeg', 0.9);
            });

            retakPhotoBtn.addEventListener('click', () => {
              photoPreview.style.display = 'none';
              video.style.display = 'block';
              photoControls.style.display = 'flex';
            });
          },
          willClose: () => {
            // Cerrar la c√°mara si se cierra el modal
            const video = document.getElementById('cameraVideo');
            if (video && video.srcObject) {
              video.srcObject.getTracks().forEach(track => track.stop());
            }
          }
        }).then((result) => {
          if (!result.isConfirmed && !result.dismiss) {
            resolve(null);
          }
        });
      });
    }

    // === FUNCIONES PARA FICHAJE POR QR ===
    let qrScanner = null;

    function setMetodoEmpleado(metodo) {
      const btnGps = document.getElementById('btn-metodo-gps');
      const btnQr = document.getElementById('btn-metodo-qr');
      const seccionGps = document.getElementById('fichaje-gps-section');
      const seccionQr = document.getElementById('fichaje-qr-section');

      if (metodo === 'gps') {
        btnGps.classList.remove('bg-slate-300', 'text-slate-700');
        btnGps.classList.add('bg-cyan-600', 'text-white');
        btnQr.classList.add('bg-slate-300', 'text-slate-700');
        btnQr.classList.remove('bg-purple-600', 'text-white');

        seccionGps.classList.remove('hidden');
        seccionQr.classList.add('hidden');
      } else {
        btnQr.classList.remove('bg-slate-300', 'text-slate-700');
        btnQr.classList.add('bg-purple-600', 'text-white');
        btnGps.classList.add('bg-slate-300', 'text-slate-700');
        btnGps.classList.remove('bg-cyan-600', 'text-white');

        seccionQr.classList.remove('hidden');
        seccionGps.classList.add('hidden');
      }
    }

    async function escanearQR(tipo) {
      // Verificar √∫ltimo fichaje antes de proceder
      try {
        const lastLogRes = await fetch(`/api/last-log/${currentUser.id}`);
        const lastLog = await lastLogRes.json();

        if (lastLog) {
          if (lastLog.tipo === 'ENTRADA' && tipo === 'ENTRADA') {
            Swal.fire({
              icon: 'warning',
              title: 'Ya fichaste la entrada',
              text: 'Debes escanear para la salida ahora',
              confirmButtonColor: '#f97316'
            });
            return;
          }
          if (lastLog.tipo === 'SALIDA' && tipo === 'SALIDA') {
            Swal.fire({
              icon: 'warning',
              title: 'Ya fichaste la salida',
              text: 'Debes escanear para la entrada ahora',
              confirmButtonColor: '#16a34a'
            });
            return;
          }
        }
      } catch (error) {
        console.error('Error verificando √∫ltimo fichaje:', error);
      }

      const { value: formValues } = await Swal.fire({
        title: `üì± Escanea el c√≥digo QR`,
        html: `
          <div class="text-center">
            <p class="mb-4 text-sm text-gray-600">Apunta la c√°mara al c√≥digo QR en la pantalla del admin</p>
            <div id="qr-reader" class="border-2 border-cyan-500 rounded-lg overflow-hidden mx-auto" style="width: 100%; max-width: 500px;"></div>
          </div>
        `,
        showCancelButton: true,
        showConfirmButton: false,
        cancelButtonText: 'Cancelar',
        didOpen: () => {
          const qrReader = new Html5Qrcode("qr-reader");

          qrReader.start(
            { facingMode: "environment" },
            {
              fps: 10,
              qrbox: { width: 250, height: 250 }
            },
            async (decodedText) => {
              // QR escaneado exitosamente
              qrReader.stop();

              Swal.fire({
                title: 'Validando...',
                text: 'Verificando c√≥digo QR',
                allowOutsideClick: false,
                didOpen: () => {
                  Swal.showLoading();
                }
              });

              try {
                const response = await fetch('/api/qr/validate', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    token: decodedText,
                    userId: currentUser.id,
                    tipo: tipo
                  })
                });

                const data = await response.json();

                if (response.ok) {
                  Swal.fire({
                    icon: 'success',
                    title: '¬°Fichaje registrado!',
                    html: `<strong>${data.tipo}</strong> registrada correctamente con QR`,
                    confirmButtonColor: tipo === 'ENTRADA' ? '#16a34a' : '#f97316'
                  });
                } else {
                  Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.error || 'No se pudo registrar el fichaje'
                  });
                }
              } catch (error) {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: 'Error de conexi√≥n. Intenta de nuevo.'
                });
              }
            },
            (errorMessage) => {
              // Error escaneando (se muestra solo si es relevante)
            }
          ).catch((err) => {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'No se pudo acceder a la c√°mara. Verifica los permisos.'
            });
          });

          qrScanner = qrReader;
        },
        willClose: () => {
          if (qrScanner) {
            qrScanner.stop().catch(() => { });
          }
        }
      });
    }

    async function renderAdmin() {
      const app = document.getElementById('app');

      try {
        const [logsRes, statsRes, configRes] = await Promise.all([
          fetch('/api/logs'),
          fetch('/api/stats'),
          fetch('/api/config')
        ]);

        const logs = await logsRes.json();
        const stats = await statsRes.json();
        const config = await configRes.json();

        app.innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4">
            <div class="max-w-7xl mx-auto">
              <!-- Tabs de navegaci√≥n -->
              <div class="bg-white rounded-lg shadow-xl mb-4 border-2 border-slate-200">
                <div class="flex border-b border-slate-200">
                  <button onclick="showTab('config')" id="tab-config" class="flex-1 py-4 px-6 font-bold border-b-2 border-cyan-600 text-cyan-600">
                    ‚öôÔ∏è Configuraci√≥n
                  </button>
                  <button onclick="showTab('users')" id="tab-users" class="flex-1 py-4 px-6 font-semibold text-slate-500 hover:text-slate-700">
                    üë• Empleados
                  </button>
                  <button onclick="showTab('schedule')" id="tab-schedule" class="flex-1 py-4 px-6 font-semibold text-slate-500 hover:text-slate-700">
                    üìÖ Horarios
                  </button>
                  <button onclick="showTab('logs')" id="tab-logs" class="flex-1 py-4 px-6 font-semibold text-slate-500 hover:text-slate-700">
                    üìä Fichajes
                  </button>
                </div>
              </div>

              <!-- Tab: Configuraci√≥n -->
              <div id="content-config" class="tab-content">
              
              <!-- Selector de M√©todo de Fichaje -->
              <div class="bg-white rounded-lg shadow-xl p-6 mb-4 border-2 border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">üîß M√©todo de Fichaje</h2>
                
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                  <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition hover:border-cyan-500 ${config.metodo_fichaje === 'gps' ? 'border-cyan-500 bg-cyan-50' : 'border-slate-300'}">
                    <input type="radio" name="metodo_fichaje" value="gps" ${config.metodo_fichaje === 'gps' ? 'checked' : ''} onchange="cambiarMetodoFichaje('gps')" class="mr-3">
                    <div>
                      <p class="font-bold text-slate-800">üìç GPS/Geolocalizaci√≥n</p>
                      <p class="text-xs text-slate-600">Fichaje por ubicaci√≥n</p>
                    </div>
                  </label>
                  
                  <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition hover:border-purple-500 ${config.metodo_fichaje === 'qr' ? 'border-purple-500 bg-purple-50' : 'border-slate-300'}">
                    <input type="radio" name="metodo_fichaje" value="qr" ${config.metodo_fichaje === 'qr' ? 'checked' : ''} onchange="cambiarMetodoFichaje('qr')" class="mr-3">
                    <div>
                      <p class="font-bold text-slate-800">üì± C√≥digo QR</p>
                      <p class="text-xs text-slate-600">Escaneo de QR din√°mico</p>
                    </div>
                  </label>
                  
                  <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition hover:border-emerald-500 ${config.metodo_fichaje === 'ambos' ? 'border-emerald-500 bg-emerald-50' : 'border-slate-300'}">
                    <input type="radio" name="metodo_fichaje" value="ambos" ${config.metodo_fichaje === 'ambos' ? 'checked' : ''} onchange="cambiarMetodoFichaje('ambos')" class="mr-3">
                    <div>
                      <p class="font-bold text-slate-800">üîÑ Ambos M√©todos</p>
                      <p class="text-xs text-slate-600">Empleado elige</p>
                    </div>
                  </label>
                </div>
              </div>
              
              <!-- Configuraci√≥n GPS -->
              <div id="config-gps-section" class="${config.metodo_fichaje === 'qr' ? 'hidden' : ''}">
                <div class="bg-white rounded-lg shadow-xl p-6 mb-4 border-2 border-slate-200">
                  <h2 class="text-2xl font-bold text-slate-800 mb-4">‚öôÔ∏è Configuraci√≥n de Ubicaci√≥n GPS</h2>
                  
                  <!-- Vista previa del mapa -->
                  <div id="map-preview-admin" class="mb-4 bg-slate-100 rounded-lg overflow-hidden border-2 border-slate-300" style="min-height: 300px;">
                    <iframe 
                      width="100%" 
                      height="300" 
                      frameborder="0" 
                      style="border:0; border-radius: 8px;" 
                      src="https://www.google.com/maps?q=${config.lat || 40.4168},${config.lon || -3.7038}&z=18&output=embed"
                      allowfullscreen>
                    </iframe>
                  </div>
                  
                  <div class="grid md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-semibold text-slate-700 mb-2">üìç Direcci√≥n del Restaurante:</label>
                      <div class="flex gap-2 mb-3">
                        <input type="text" id="configAddress" value="${config.address || ''}" placeholder="Calle Principal 123, Madrid" class="flex-1 px-3 py-2 border-2 border-slate-300 rounded-lg focus:border-cyan-500 focus:outline-none">
                        <button onclick="applyAddress()" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold px-4 rounded-lg transition whitespace-nowrap">
                          üîç Buscar
                        </button>
                      </div>
                      
                      <label class="block text-sm font-semibold text-slate-700 mb-2">Radio M√°ximo (metros):</label>
                      <input type="number" id="configDistance" value="${config.maxDistance}" class="w-full px-3 py-2 border-2 border-slate-300 rounded-lg mb-3 focus:border-cyan-500 focus:outline-none">
                      
                      <!-- Coordenadas ocultas (solo para uso interno) -->
                      <input type="hidden" id="configLat" value="${config.lat}">
                      <input type="hidden" id="configLon" value="${config.lon}">
                    </div>
                    <div class="flex flex-col justify-center gap-2">
                      <button onclick="useCurrentLocation()" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition">
                        üìç Usar Mi Ubicaci√≥n Actual
                      </button>
                      <button onclick="saveConfig()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg transition">
                        üíæ Guardar Configuraci√≥n
                      </button>
                      <button onclick="resetConfig()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg transition text-sm">
                        üîÑ Resetear a Defecto
                      </button>
                      <p class="text-xs text-slate-500 mt-1">üí° Si tienes problemas de "demasiado lejos", resetea la config</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Configuraci√≥n QR -->
              <div id="config-qr-section" class="${config.metodo_fichaje === 'gps' ? 'hidden' : ''}">
                <div class="bg-white rounded-lg shadow-xl p-6 mb-4 border-2 border-slate-200">
                  <h2 class="text-2xl font-bold text-slate-800 mb-4">üì± Configuraci√≥n C√≥digo QR</h2>
                  
                  <div class="max-w-md">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">‚è±Ô∏è Duraci√≥n del QR:</label>
                    <select id="configQrDuracion" onchange="saveConfig()" class="w-full px-3 py-2 border-2 border-slate-300 rounded-lg focus:border-purple-500 focus:outline-none mb-3">
                      <option value="30" ${config.qr_duracion === 30 ? 'selected' : ''}>30 segundos</option>
                      <option value="60" ${config.qr_duracion === 60 ? 'selected' : ''}>1 minuto</option>
                      <option value="300" ${config.qr_duracion === 300 ? 'selected' : ''}>5 minutos</option>
                    </select>
                    <p class="text-xs text-slate-500 mb-4">üí° Menor duraci√≥n = Mayor seguridad</p>
                    
                    <label class="block text-sm font-semibold text-slate-700 mb-2">üîí PIN de Acceso al QR:</label>
                    <input type="text" id="configQrPin" value="${config.qr_pin || '1234'}" onchange="saveConfig()" maxlength="8" placeholder="1234" class="w-full px-3 py-2 border-2 border-slate-300 rounded-lg focus:border-purple-500 focus:outline-none mb-3">
                    <p class="text-xs text-slate-500 mb-4">üîë PIN para acceder a la vista QR desde el login</p>
                    
                    <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-3 mt-4">
                      <p class="text-sm text-purple-800">üîí Por seguridad, el QR se muestra en una vista separada accesible desde el login con PIN</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Configuraci√≥n de Foto al Fichar -->
              <div class="bg-white rounded-lg shadow-xl p-6 mb-4 border-2 border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">üì∏ Control de Fichaje con Foto</h2>
                
                <div class="max-w-md">
                  <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg border-2 border-slate-200">
                    <div class="flex-1">
                      <label for="configRequirePhoto" class="font-semibold text-slate-700 cursor-pointer">
                        üì∑ Requerir foto al fichar
                      </label>
                      <p class="text-xs text-slate-500 mt-1">Los empleados deber√°n tomar una selfie al fichar</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="configRequirePhoto" ${config.require_photo ? 'checked' : ''} onchange="saveConfig()" class="sr-only peer">
                      <div class="w-14 h-7 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-cyan-600"></div>
                    </label>
                  </div>
                  
                  <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-3 mt-4">
                    <p class="text-sm text-blue-800">üí° Las fotos se guardan con cada fichaje y son visibles en los registros</p>
                    <p class="text-xs text-blue-600 mt-1">‚ö†Ô∏è Aseg√∫rate de cumplir con la normativa RGPD sobre captura de im√°genes</p>
                  </div>
                </div>
              </div>
              </div>

              <!-- Tab: Usuarios -->
              <div id="content-users" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-xl p-6 mb-4 border-2 border-slate-200">
                  <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-slate-800">üë• Gesti√≥n de Empleados</h2>
                    <button onclick="showCreateUserModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg">
                      ‚ûï Nuevo Usuario
                    </button>
                  </div>
                  <div id="users-list"></div>
                </div>
              </div>

              <!-- Tab: Horarios -->
              <div id="content-schedule" class="tab-content hidden">
                <!-- Barra de herramientas -->
                <div class="bg-white rounded-lg shadow-xl p-6 mb-4 border-2 border-slate-200">
                  <h2 class="text-2xl font-bold text-slate-800 mb-4">üìÖ Gesti√≥n de Horarios</h2>
                  
                  <div class="bg-slate-100 rounded-lg p-4 space-y-3 border-2 border-slate-200">
                    <div class="flex flex-wrap gap-2">
                      <button onclick="showCreateScheduleModal()" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg">
                        ‚ûï A√±adir Horario Manual
                      </button>
                      <select id="filter-employee" onchange="filterSchedules()" class="px-4 py-2 border-2 border-slate-300 rounded-lg font-semibold focus:border-cyan-500 focus:outline-none">
                        <option value="">Todos los empleados</option>
                      </select>
                      <button onclick="deleteAllSchedules()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                        üóëÔ∏è Eliminar Todos
                      </button>
                      <button onclick="deleteSchedulesByEmployee()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg">
                        üë§ Eliminar por Empleado
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Opci√≥n 1: Subir foto con IA -->
                <div class="bg-white rounded-lg shadow-xl p-6 mb-4 border-2 border-slate-200">
                  <h2 class="text-2xl font-bold text-slate-800 mb-4">ü§ñ Subir Foto con IA</h2>
                  
                  <div class="bg-gradient-to-r from-purple-600 to-fuchsia-600 border-2 border-purple-700 rounded-lg p-4">
                    <h3 class="text-lg font-bold text-white mb-2">Cargar Imagen</h3>
                    <div class="flex gap-2">
                      <input type="file" id="schedule-image" accept="image/*" capture="environment" class="flex-1 px-4 py-2 border-2 border-white rounded-lg bg-white">
                      <button onclick="uploadScheduleImage()" class="bg-white hover:bg-purple-50 text-purple-700 font-bold py-2 px-6 rounded-lg whitespace-nowrap border-2 border-white">
                        üöÄ Procesar con IA
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Vista de calendario -->
                <div class="bg-white rounded-lg shadow-xl p-6 mb-4 border-2 border-slate-200">
                  <h2 class="text-2xl font-bold text-slate-800 mb-4">üìÜ Calendario de Horarios</h2>
                  <div id="schedules-calendar"></div>
                </div>
              </div>

              <!-- Tab: Fichajes -->
              <div id="content-logs" class="tab-content hidden">
                <!-- Barra de herramientas de Fichajes -->
                <div class="bg-white rounded-lg shadow-xl p-6 mb-4 border-2 border-slate-200">
                  <h2 class="text-2xl font-bold text-slate-800 mb-4">üìä Registro de Fichajes</h2>
                  
                  <div class="bg-slate-100 rounded-lg p-4 space-y-3 border-2 border-slate-200">
                    <!-- Filtros -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                      <div>
                        <label class="block text-xs font-semibold text-slate-700 mb-1">üë§ Empleado:</label>
                        <select id="filter-log-employee" onchange="filterLogs()" class="w-full px-3 py-2 border-2 border-slate-300 rounded-lg focus:border-cyan-500 focus:outline-none text-sm">
                          <option value="">Todos los empleados</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-xs font-semibold text-slate-700 mb-1">üìå Tipo:</label>
                        <select id="filter-log-type" onchange="filterLogs()" class="w-full px-3 py-2 border-2 border-slate-300 rounded-lg focus:border-cyan-500 focus:outline-none text-sm">
                          <option value="">Todos los tipos</option>
                          <option value="ENTRADA">üìç Entrada</option>
                          <option value="SALIDA">üö™ Salida</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-xs font-semibold text-slate-700 mb-1">üìÖ Desde:</label>
                        <input type="date" id="filter-log-date-from" onchange="filterLogs()" class="w-full px-3 py-2 border-2 border-slate-300 rounded-lg text-sm focus:border-cyan-500 focus:outline-none">
                      </div>
                      <div>
                        <label class="block text-xs font-semibold text-slate-700 mb-1">üìÖ Hasta:</label>
                        <input type="date" id="filter-log-date-to" onchange="filterLogs()" class="w-full px-3 py-2 border-2 border-slate-300 rounded-lg text-sm focus:border-cyan-500 focus:outline-none">
                      </div>
                    </div>
                    
                    <!-- Botones de acci√≥n -->
                    <div class="flex flex-wrap gap-2">
                      <button onclick="filterLogs()" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition">
                        üîç Buscar
                      </button>
                      <button onclick="clearLogFilters()" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition">
                        üîÑ Limpiar Filtros
                      </button>
                      <button onclick="exportFilteredLogsToCSV()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg transition">
                        üì• Exportar CSV
                      </button>
                      <button onclick="deleteAllLogs()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">
                        üóëÔ∏è Eliminar Todos
                      </button>
                      <button onclick="deleteLogsByEmployee()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition">
                        üë§ Eliminar por Empleado
                      </button>
                    </div>
                    
                    <!-- Estad√≠sticas r√°pidas -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3">
                      <div class="bg-white rounded-lg p-3 border-2 border-cyan-200">
                        <p class="text-xs text-slate-600 font-semibold">Total Registros</p>
                        <p id="stat-total-logs" class="text-2xl font-bold text-cyan-600">0</p>
                      </div>
                      <div class="bg-white rounded-lg p-3 border-2 border-emerald-200">
                        <p class="text-xs text-slate-600 font-semibold">Entradas</p>
                        <p id="stat-total-entries" class="text-2xl font-bold text-emerald-600">0</p>
                      </div>
                      <div class="bg-white rounded-lg p-3 border-2 border-orange-200">
                        <p class="text-xs text-slate-600 font-semibold">Salidas</p>
                        <p id="stat-total-exits" class="text-2xl font-bold text-orange-600">0</p>
                      </div>
                      <div class="bg-white rounded-lg p-3 border-2 border-purple-200">
                        <p class="text-xs text-slate-600 font-semibold">Mostrando</p>
                        <p id="stat-filtered-logs" class="text-2xl font-bold text-purple-600">0</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Tabla de registros -->
                <div class="bg-white rounded-lg shadow-xl p-6 mb-4 border-2 border-slate-200">
                  <h3 class="text-xl font-bold text-slate-800 mb-4">üìã Listado de Fichajes</h3>
                  <div class="overflow-x-auto">
                  <div id="logs-table-container">
                  <table class="w-full border-collapse table-fixed">
                    <thead>
                      <tr class="bg-gray-200 border-b">
                        <th class="p-3 text-center font-semibold" style="width: 80px;">ID</th>
                        <th class="p-3 text-left font-semibold">Empleado</th>
                        <th class="p-3 text-center font-semibold" style="width: 140px;">Tipo</th>
                        <th class="p-3 text-left font-semibold" style="width: 180px;">Fecha/Hora</th>
                        <th class="p-3 text-center font-semibold" style="width: 180px;">M√©todo / Validaci√≥n</th>
                        <th class="p-3 text-center font-semibold" style="width: 140px;">Foto</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${logs.length === 0 ? '<tr><td colspan="5" class="p-3 text-center text-gray-500">No hay registros</td></tr>' :
            logs.map(log => {
              const esQR = log.lat === 0 && log.lon === 0;
              let metodoBadge = '';

              if (esQR) {
                metodoBadge = '<span class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-800">üì± QR</span>';
              } else {
                const R = 6371000;
                const restaurantLat = config.lat;
                const restaurantLon = config.lon;
                const maxDist = config.maxDistance;

                const dLat = (log.lat - restaurantLat) * Math.PI / 180;
                const dLon = (log.lon - restaurantLon) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(restaurantLat * Math.PI / 180) * Math.cos(log.lat * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const distancia = Math.round(R * c);
                const enRango = distancia <= maxDist;

                if (enRango) {
                  metodoBadge = '<span class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-800">‚úì GPS (' + distancia + 'm)</span>';
                } else {
                  metodoBadge = '<span class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800">‚úó GPS (' + distancia + 'm)</span>';
                }
              }

              return '<tr class="border-b hover:bg-gray-50">' +
                '<td class="p-3 text-center" style="vertical-align: middle;">' + log.id + '</td>' +
                '<td class="p-3 font-semibold" style="vertical-align: middle;">' + log.nombre + '</td>' +
                '<td class="p-3 text-center" style="vertical-align: middle;">' +
                '<span class="inline-block px-3 py-1 rounded-full text-sm font-semibold ' + (log.tipo === 'ENTRADA' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800') + '">' +
                (log.tipo === 'ENTRADA' ? 'üìç ' : 'üö™ ') + log.tipo +
                '</span>' +
                '</td>' +
                '<td class="p-3" style="vertical-align: middle;">' + new Date(log.fecha).toLocaleString('es-ES') + '</td>' +
                '<td class="p-3 text-center" style="vertical-align: middle;">' + metodoBadge + '</td>' +
                '<td class="p-3 text-center" style="vertical-align: middle;">' +
                  (log.foto_url ? `<a href="${log.foto_url}" target="_blank" class="inline-flex items-center gap-2">
                    <img src="${log.foto_url}" alt="foto" class="w-14 h-14 object-cover rounded border" />
                  </a>` : '<span class="text-xs text-slate-400">Sin foto</span>') +
                '</td>' +
                '</tr>';
            }).join('')
          }
                    </tbody>
                  </table>
                  </div>
                  </div>
                </div>
              </div>

              <!-- Bot√≥n de cerrar sesi√≥n -->
              <div class="flex justify-end mt-6">
                <button onclick="logout()" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-lg hover:shadow-xl">
                  üö™ Cerrar Sesi√≥n
                </button>
              </div>
            </div>
          </div>
        `;

        // Cargar datos iniciales
        loadUsersList();
        loadSchedulesList();

      } catch (error) {
        console.error('Error cargando panel admin:', error);
        app.innerHTML = '<div class="p-4 text-red-600">Error al cargar el panel de administraci√≥n</div>';
      }
    }

    function showTab(tabName) {
      // Ocultar todos los tabs
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
      document.querySelectorAll('[id^="tab-"]').forEach(btn => {
        btn.classList.remove('border-cyan-600', 'text-cyan-600');
        btn.classList.add('text-slate-500');
      });

      // Mostrar el tab seleccionado
      document.getElementById(`content-${tabName}`).classList.remove('hidden');
      document.getElementById(`tab-${tabName}`).classList.add('border-cyan-600', 'text-cyan-600');
      document.getElementById(`tab-${tabName}`).classList.remove('text-slate-500');

      // Cargar datos espec√≠ficos del tab
      if (tabName === 'logs') {
        loadLogsData();
      }
    }

    async function loadUsersList() {
      try {
        const response = await fetch('/api/users');
        const allUsers = await response.json();

        const usersListDiv = document.getElementById('users-list');
        if (allUsers.length === 0) {
          usersListDiv.innerHTML = '<p class="text-gray-500 text-center">No hay usuarios</p>';
          return;
        }

        usersListDiv.innerHTML = `
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-slate-100 border-b border-slate-300">
                  <th class="p-3 text-center font-semibold text-slate-700" style="width: 80px;">ID</th>
                  <th class="p-3 text-left font-semibold text-slate-700">Nombre</th>
                  <th class="p-3 text-left font-semibold text-slate-700">Usuario</th>
                  <th class="p-3 text-center font-semibold text-slate-700" style="width: 150px;">Rol</th>
                  <th class="p-3 text-center font-semibold text-slate-700" style="width: 200px;">Acciones</th>
                </tr>
              </thead>
              <tbody>
                ${allUsers.map(user => `
                  <tr class="border-b border-slate-200 hover:bg-slate-50 transition">
                    <td class="p-3 text-center" style="vertical-align: middle;">${user.id}</td>
                    <td class="p-3 font-semibold" style="vertical-align: middle;">${user.nombre}</td>
                    <td class="p-3 text-left" style="vertical-align: middle;">${user.username}</td>
                    <td class="p-3 text-center" style="vertical-align: middle;">
                      <span class="inline-block px-3 py-1 rounded-full text-sm font-bold ${user.rol === 'admin' ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-cyan-100 text-cyan-700 border border-cyan-300'}">
                        ${user.rol === 'admin' ? 'üîê Admin' : 'üë§ Empleado'}
                      </span>
                    </td>
                    <td class="p-3 text-center" style="vertical-align: middle;">
                      <div class="flex justify-center gap-2">
                        <button onclick="editUser(${user.id}, '${user.nombre}', '${user.username}', '${user.email || ''}', '${user.rol}')" class="bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1 rounded">
                          ‚úèÔ∏è Editar
                        </button>
                        <button onclick="deleteUser(${user.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">
                          üóëÔ∏è Eliminar
                        </button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error cargando usuarios:', error);
      }
    }

    function showCreateUserModal() {
      Swal.fire({
        title: 'Crear Nuevo Usuario',
        html: `
          <input id="swal-nombre" class="swal2-input" placeholder="Nombre Completo">
          <input id="swal-username" class="swal2-input" placeholder="Usuario (login)">
          <input id="swal-email" class="swal2-input" placeholder="Email (opcional)">
          <input id="swal-password" type="password" class="swal2-input" placeholder="Contrase√±a">
          <select id="swal-rol" class="swal2-input">
            <option value="">Selecciona un rol</option>
            <option value="camarero">Camarero/Empleado</option>
            <option value="admin">Administrador</option>
          </select>
        `,
        showCancelButton: true,
        confirmButtonText: 'Crear',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
          const nombre = document.getElementById('swal-nombre').value;
          const username = document.getElementById('swal-username').value;
          const email = document.getElementById('swal-email').value;
          const password = document.getElementById('swal-password').value;
          const rol = document.getElementById('swal-rol').value;

          if (!nombre || !username || !rol || !password) {
            Swal.showValidationMessage('Todos los campos son obligatorios excepto email');
            return false;
          }
          return { nombre, username, email, password, rol };
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const response = await fetch('/api/users', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(result.value)
            });
            if (response.ok) {
              Swal.fire('¬°Creado!', 'Usuario creado correctamente', 'success');
              loadUsersList();
            }
          } catch (error) {
            Swal.fire('Error', 'No se pudo crear el usuario', 'error');
          }
        }
      });
    }

    function editUser(id, nombre, rol) {
      Swal.fire({
        title: 'Editar Usuario',
        html: `
          <input id="swal-nombre" class="swal2-input" value="${nombre}" placeholder="Nombre">
          <input id="swal-username" class="swal2-input" value="${user.username || ''}" placeholder="Usuario (login)">
          <input id="swal-email" class="swal2-input" value="${user.email || ''}" placeholder="Email (opcional)">
          <input id="swal-password" type="password" class="swal2-input" placeholder="Nueva contrase√±a (opcional)">
          <select id="swal-rol" class="swal2-input">
            <option value="camarero" ${rol === 'camarero' ? 'selected' : ''}>Camarero/Empleado</option>
            <option value="admin" ${rol === 'admin' ? 'selected' : ''}>Administrador</option>
          </select>
        `,
        showCancelButton: true,
        confirmButtonText: 'Guardar',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
          return {
            nombre: document.getElementById('swal-nombre').value,
            username: document.getElementById('swal-username').value,
            email: document.getElementById('swal-email').value,
            password: document.getElementById('swal-password').value,
            rol: document.getElementById('swal-rol').value
          };
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const response = await fetch(`/api/users/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(result.value)
            });
            if (response.ok) {
              Swal.fire('¬°Actualizado!', 'Usuario actualizado correctamente', 'success');
              loadUsersList();
            }
          } catch (error) {
            Swal.fire('Error', 'No se pudo actualizar el usuario', 'error');
          }
        }
      });
    }

    function deleteUser(id) {
      Swal.fire({
        title: '¬øEst√°s seguro?',
        text: 'Esta acci√≥n no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const response = await fetch(`/api/users/${id}`, { method: 'DELETE' });
            if (response.ok) {
              Swal.fire('¬°Eliminado!', 'Usuario eliminado correctamente', 'success');
              loadUsersList();
            }
          } catch (error) {
            Swal.fire('Error', 'No se pudo eliminar el usuario', 'error');
          }
        }
      });
    }

    async function loadSchedulesList() {
      try {
        // No expandir en la lista de administraci√≥n, solo en la vista del empleado
        const response = await fetch('/api/horarios');
        const schedules = await response.json();

        const schedulesDiv = document.getElementById('schedules-calendar');
        const filterSelect = document.getElementById('filter-employee');

        // Obtener usuarios para el filtro
        const usersResponse = await fetch('/api/users');
        const allUsers = await usersResponse.json();

        // Actualizar opciones del filtro
        filterSelect.innerHTML = '<option value="">Todos los empleados</option>' +
          allUsers.filter(u => u.rol !== 'admin').map(u =>
            `<option value="${u.id}">${u.nombre}</option>`
          ).join('');

        if (schedules.length === 0) {
          schedulesDiv.innerHTML = '<p class="text-gray-500 text-center p-8">No hay horarios configurados. Sube una foto o crea uno manualmente.</p>';
          return;
        }

        // Agrupar por empleado
        const byEmployee = {};
        schedules.forEach(s => {
          if (!byEmployee[s.user_id]) {
            byEmployee[s.user_id] = { nombre: s.nombre, horarios: [] };
          }
          byEmployee[s.user_id].horarios.push(s);
        });

        const diasOrden = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

        schedulesDiv.innerHTML = Object.entries(byEmployee).map(([userId, data]) => {
          // Organizar horarios por d√≠a
          const horariosPorDia = {};
          diasOrden.forEach(dia => horariosPorDia[dia] = []);
          data.horarios.forEach(h => {
            if (horariosPorDia[h.dia_semana]) {
              horariosPorDia[h.dia_semana].push(h);
            }
          });

          return `
            <div class="border-2 border-gray-300 rounded-lg p-4 mb-4 employee-schedule" data-employee-id="${userId}">
              <div class="flex justify-between items-center mb-3">
                <h3 class="text-xl font-bold text-gray-800">üë§ ${data.nombre}</h3>
                <div class="space-x-2">
                  <button onclick="editEmployeeSchedule(${userId})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                    ‚úèÔ∏è Editar
                  </button>
                  <button onclick="deleteEmployeeSchedules(${userId}, '${data.nombre}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                    üóëÔ∏è Eliminar Todo
                  </button>
                </div>
              </div>
              
              <div class="grid grid-cols-7 gap-2">
                ${diasOrden.map(dia => {
            const horariosDelDia = horariosPorDia[dia];
            const tieneHorarios = horariosDelDia.length > 0;

            return `
                    <div class="border rounded-lg overflow-hidden ${tieneHorarios ? 'bg-blue-50 border-blue-300' : 'bg-gray-50 border-gray-200'}">
                      <div class="bg-gray-700 text-white text-center py-2 font-bold text-sm">
                        ${dia.substring(0, 3)}
                      </div>
                      <div class="p-2 min-h-[100px]">
                        ${tieneHorarios ? horariosDelDia.map(h => `
                          <div class="mb-2 p-2 bg-white rounded border ${h.es_recurrente ? 'border-green-300 bg-green-50' : (h.fecha_desde ? 'border-purple-300 bg-purple-50' : 'border-blue-200')} relative group">
                            <button onclick="deleteSchedule(${h.id})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs opacity-0 group-hover:opacity-100 transition">
                              √ó
                            </button>
                            ${h.es_recurrente ? `<div class="text-center mb-1"><span class="text-xs font-bold text-green-700">üîÑ ${h.frecuencia_recurrencia || 'Recurrente'}</span></div>` : (h.fecha_desde ? `<div class="text-center mb-1"><span class="text-xs font-bold text-purple-700">üìÜ Espec√≠fico</span></div>` : '')}
                            <div class="text-center">
                              <p class="text-sm font-bold ${h.es_recurrente ? 'text-green-600' : (h.fecha_desde ? 'text-purple-600' : 'text-blue-600')}">${h.hora_inicio}</p>
                              <p class="text-xs text-gray-400">‚Üì</p>
                              <p class="text-sm font-bold ${h.es_recurrente ? 'text-green-600' : (h.fecha_desde ? 'text-purple-600' : 'text-blue-600')}">${h.hora_fin}</p>
                            </div>
                            ${h.fecha_desde && h.fecha_hasta ? `<p class="text-xs ${h.es_recurrente ? 'text-green-700' : 'text-purple-700'} mt-1 text-center">${new Date(h.fecha_desde).toLocaleDateString('es-ES')} - ${new Date(h.fecha_hasta).toLocaleDateString('es-ES')}</p>` : ''}
                            ${h.notas ? `<p class="text-xs text-gray-600 mt-1 text-center italic">${h.notas}</p>` : ''}
                          </div>
                        `).join('') + (horariosDelDia.length > 1 ? '<div class="text-center"><span class="text-xs font-bold text-red-600">üîÑ Doble turno</span></div>' : '') : `
                          <div class="flex items-center justify-center h-full text-gray-400 text-sm">
                            <div class="text-center">
                              <p class="text-2xl">üèùÔ∏è</p>
                              <p class="text-xs">Libre</p>
                            </div>
                          </div>
                        `}
                      </div>
                    </div>
                  `;
          }).join('')}
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error cargando horarios:', error);
      }
    }

    function filterSchedules() {
      const filterValue = document.getElementById('filter-employee').value;
      const schedules = document.querySelectorAll('.employee-schedule');

      schedules.forEach(schedule => {
        if (!filterValue || schedule.dataset.employeeId === filterValue) {
          schedule.style.display = 'block';
        } else {
          schedule.style.display = 'none';
        }
      });
    }

    async function deleteEmployeeSchedules(userId, nombre) {
      const result = await Swal.fire({
        title: `¬øEliminar TODOS los horarios de ${nombre}?`,
        text: 'Esta acci√≥n no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        confirmButtonText: 'S√≠, eliminar todos',
        cancelButtonText: 'Cancelar'
      });

      if (result.isConfirmed) {
        try {
          const response = await fetch('/api/horarios');
          const allSchedules = await response.json();
          const schedulesToDelete = allSchedules.filter(s => s.user_id === parseInt(userId));

          for (const schedule of schedulesToDelete) {
            await fetch(`/api/horarios/${schedule.id}`, { method: 'DELETE' });
          }

          Swal.fire('¬°Eliminados!', `Se eliminaron ${schedulesToDelete.length} horarios`, 'success');
          loadSchedulesList();
        } catch (error) {
          Swal.fire('Error', 'No se pudieron eliminar los horarios', 'error');
        }
      }
    }

    async function deleteAllSchedules() {
      const result = await Swal.fire({
        title: '¬øEliminar TODOS los horarios?',
        text: 'Esta acci√≥n eliminar√° todos los horarios de todos los empleados',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        confirmButtonText: 'S√≠, eliminar TODOS',
        cancelButtonText: 'Cancelar'
      });

      if (result.isConfirmed) {
        try {
          const response = await fetch('/api/horarios');
          const allSchedules = await response.json();

          for (const schedule of allSchedules) {
            await fetch(`/api/horarios/${schedule.id}`, { method: 'DELETE' });
          }

          Swal.fire('¬°Eliminados!', `Se eliminaron ${allSchedules.length} horarios`, 'success');
          loadSchedulesList();
        } catch (error) {
          Swal.fire('Error', 'No se pudieron eliminar los horarios', 'error');
        }
      }
    }

    // Funci√≥n para validar que hora_fin > hora_inicio
    function validateScheduleLogic(inicio, fin) {
      if (!inicio || !fin) return true; // Si faltan datos, no validar

      const [horaIni, minIni] = inicio.split(':').map(Number);
      const [horaFin, minFin] = fin.split(':').map(Number);

      const minutosInicio = horaIni * 60 + minIni;
      const minutosFin = horaFin * 60 + minFin;

      // Permitir que el fin sea menor que el inicio (turno que cruza medianoche)
      // Solo validar que no sean iguales o que el rango sea razonable
      if (minutosInicio === minutosFin) return false; // No puede terminar a la misma hora que empieza

      return true;
    }

    // Funci√≥n para validar en tiempo real
    function validateSchedule(dia, turnoNum) {
      const inicioId = turnoNum === 1 ? `edit-inicio-${dia}` : `edit-inicio2-${dia}`;
      const finId = turnoNum === 1 ? `edit-fin-${dia}` : `edit-fin2-${dia}`;
      const errorId = `error-${dia}-${turnoNum}`;
      const cierreId = turnoNum === 1 ? `edit-cierre-${dia}` : `edit-cierre2-${dia}`;

      const inicio = document.getElementById(inicioId).value;
      const fin = document.getElementById(finId).value;
      const errorMsg = document.getElementById(errorId);
      const cierreChecked = document.getElementById(cierreId)?.checked;

      // Si est√° marcado "Hasta Cierre", no validar
      if (cierreChecked) {
        errorMsg.classList.add('hidden');
        return true;
      }

      if (inicio && fin) {
        const [horaIni, minIni] = inicio.split(':').map(Number);
        const [horaFin, minFin] = fin.split(':').map(Number);

        const minutosInicio = horaIni * 60 + minIni;
        const minutosFin = horaFin * 60 + minFin;

        if (minutosInicio === minutosFin) {
          errorMsg.textContent = '‚ö†Ô∏è La hora de fin no puede ser igual a la de inicio';
          errorMsg.classList.remove('hidden');
          return false;
        } else if (minutosInicio >= minutosFin) {
          errorMsg.textContent = 'üí° Turno cruza medianoche (ej: 22:00 a 02:00)';
          errorMsg.classList.remove('hidden');
          errorMsg.classList.remove('text-red-600');
          errorMsg.classList.add('text-blue-600');
          return true;
        } else {
          errorMsg.classList.add('hidden');
          return true;
        }
      }

      errorMsg.classList.add('hidden');
      return true;
    }

    // Funci√≥n para activar/desactivar "Hasta Cierre"
    function toggleCierre(dia, turnoNum) {
      const finId = turnoNum === 1 ? `edit-fin-${dia}` : `edit-fin2-${dia}`;
      const cierreId = turnoNum === 1 ? `edit-cierre-${dia}` : `edit-cierre2-${dia}`;
      const errorId = `error-${dia}-${turnoNum}`;

      const finInput = document.getElementById(finId);
      const cierreCheckbox = document.getElementById(cierreId);
      const errorMsg = document.getElementById(errorId);

      if (cierreCheckbox.checked) {
        finInput.value = '23:59';
        finInput.disabled = true;
        errorMsg.classList.add('hidden');
      } else {
        finInput.disabled = false;
        finInput.value = '';
      }
    }

    async function editEmployeeSchedule(userId) {
      try {
        const usersResponse = await fetch('/api/users');
        const allUsers = await usersResponse.json();
        const employee = allUsers.find(u => u.id === userId);

        if (!employee) {
          Swal.fire('Error', 'Empleado no encontrado', 'error');
          return;
        }

        const horariosResponse = await fetch(`/api/horarios?userId=${userId}`);
        const horarios = await horariosResponse.json();

        const diasOrden = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

        // Detectar si es recurrente y extraer fechas y frecuencia
        const esRecurrente = horarios.length > 0 ? (horarios[0].es_recurrente === 1) : false;
        const frecuenciaRecurrencia = horarios.length > 0 && horarios[0].frecuencia_recurrencia ? horarios[0].frecuencia_recurrencia : 'semanal';
        const fechaDesde = horarios.length > 0 && horarios[0].fecha_desde ? horarios[0].fecha_desde : '';
        const fechaHasta = horarios.length > 0 && horarios[0].fecha_hasta ? horarios[0].fecha_hasta : '';

        // Agrupar horarios por d√≠a
        const horariosPorDia = {};
        diasOrden.forEach(dia => horariosPorDia[dia] = []);
        horarios.forEach(h => {
          if (horariosPorDia[h.dia_semana]) {
            horariosPorDia[h.dia_semana].push(h);
          }
        });

        const result = await Swal.fire({
          title: `üìù Editar Horarios de ${employee.nombre}`,
          html: `
            <div class="text-left space-y-4">
              <!-- Info del empleado -->
              <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                <p class="text-sm font-semibold">üë§ Empleado: <span class="text-green-600">${employee.nombre}</span></p>
              </div>
              
              <!-- CHECKBOX para Horario Recurrente -->
              <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                <div class="flex items-center p-3 bg-white rounded-lg border-2 border-blue-300">
                  <input type="checkbox" id="modal-recurrent-checkbox" onchange="toggleRecurrentMode()" ${esRecurrente ? 'checked' : ''} class="w-5 h-5 mr-3">
                  <div class="flex-grow">
                    <label for="modal-recurrent-checkbox" class="font-bold text-blue-700 cursor-pointer">
                      üîÑ Horario Recurrente
                    </label>
                    <p class="text-xs text-slate-600 mt-1">El horario se repetir√° autom√°ticamente seg√∫n la frecuencia elegida</p>
                  </div>
                </div>
                
                <!-- Selector de Frecuencia (solo visible cuando recurrente est√° activo) -->
                <div id="frequency-selector" class="mt-3 hidden">
                  <label class="block text-sm font-semibold mb-2 text-blue-800">üîÅ Frecuencia de Repetici√≥n:</label>
                  <select id="modal-frequency" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg bg-white focus:border-blue-500 font-medium">
                    <option value="semanal" ${frecuenciaRecurrencia === 'semanal' ? 'selected' : ''}>üìÖ Semanal (se repite cada semana)</option>
                    <option value="quincenal" ${frecuenciaRecurrencia === 'quincenal' ? 'selected' : ''}>üìÜ Quincenal (se repite cada 2 semanas)</option>
                    <option value="mensual" ${frecuenciaRecurrencia === 'mensual' ? 'selected' : ''}>üìÜ Mensual (se repite cada mes)</option>
                    <option value="trimestral" ${frecuenciaRecurrencia === 'trimestral' ? 'selected' : ''}>üìä Trimestral (se repite cada 3 meses)</option>
                    <option value="anual" ${frecuenciaRecurrencia === 'anual' ? 'selected' : ''}>üóìÔ∏è Anual (se repite cada a√±o)</option>
                  </select>
                  <p class="text-xs text-blue-600 mt-2 font-semibold">üí° El horario configurado se repetir√° con esta frecuencia durante todo el rango de fechas</p>
                </div>
              </div>

              <!-- Selector de fechas -->
              <div id="date-range-selector" class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                <label class="block text-sm font-semibold mb-2">üìÖ Rango de Fechas:</label>
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="text-xs text-gray-600">Desde:</label>
                    <input type="date" id="specific-date-from" value="${fechaDesde}" onchange="updateCalendarWithDates()" class="w-full px-3 py-2 border rounded-lg">
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Hasta:</label>
                    <input type="date" id="specific-date-to" value="${fechaHasta}" onchange="updateCalendarWithDates()" class="w-full px-3 py-2 border rounded-lg">
                  </div>
                </div>
                <p id="date-range-message" class="text-xs text-slate-600 mt-2">El horario solo aplica para este rango de fechas</p>
              </div>

              <!-- Calendario editable -->
              <div id="calendar-grid" class="bg-white border rounded-lg">
                <!-- Se genera din√°micamente -->
              </div>

              <div id="tip-message" class="bg-yellow-50 p-3 rounded-lg border border-yellow-300 text-sm">
                üí° <strong>Tip:</strong> Usa el bot√≥n ‚ö° para copiar un horario a todos los d√≠as. Deja vac√≠os los d√≠as libres.
              </div>
              
              <!-- Bot√≥n de copia r√°pida -->
              <div id="quick-copy-section" class="mt-3">
                <button type="button" onclick="quickCopyFirstDay()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                  ‚ö° Copiar primer d√≠a a todos
                </button>
                <span class="text-xs text-gray-500 ml-2">Rellena el primer d√≠a con horario y haz clic aqu√≠</span>
              </div>
            </div>
          `,
          width: '95%',
          showCancelButton: true,
          confirmButtonText: '‚úÖ Guardar Cambios',
          cancelButtonText: '‚ùå Cancelar',
          confirmButtonColor: '#10b981',
          didOpen: () => {
            // Generar vista inicial y pre-llenar datos
            generateCalendarView('week');

            // Pre-llenar horarios existentes
            diasOrden.forEach(dia => {
              const horariosDelDia = horariosPorDia[dia];
              if (horariosDelDia.length > 0) {
                // Turno 1
                const turno1 = horariosDelDia[0];
                const inicioInput = document.getElementById(`time-inicio-${dia}`);
                const finInput = document.getElementById(`time-fin-${dia}`);
                const notasInput = document.getElementById(`time-notas-${dia}`);
                if (inicioInput) inicioInput.value = turno1.hora_inicio;
                if (finInput) finInput.value = turno1.hora_fin;
                if (notasInput) notasInput.value = turno1.notas || '';

                // Turno 2 si existe
                if (horariosDelDia.length > 1) {
                  const turno2 = horariosDelDia[1];
                  const checkbox = document.getElementById(`enable-turn2-${dia}`);
                  if (checkbox) {
                    checkbox.checked = true;
                    toggleTurn2(dia);
                  }
                  const inicio2Input = document.getElementById(`time-inicio2-${dia}`);
                  const fin2Input = document.getElementById(`time-fin2-${dia}`);
                  const notas2Input = document.getElementById(`time-notas2-${dia}`);
                  if (inicio2Input) inicio2Input.value = turno2.hora_inicio;
                  if (fin2Input) fin2Input.value = turno2.hora_fin;
                  if (notas2Input) notas2Input.value = turno2.notas || '';
                }
              }
            });

            // Establecer fechas si no existen
            if (!fechaDesde || !fechaHasta) {
              const today = new Date();
              const endDate = new Date();
              endDate.setDate(today.getDate() + 6); // 7 d√≠as incluyendo el primero
              document.getElementById('specific-date-from').valueAsDate = today;
              document.getElementById('specific-date-to').valueAsDate = endDate;
            }

            // Actualizar UI seg√∫n el estado
            toggleRecurrentMode();
          },
          preConfirm: () => {
            const isRecurrent = document.getElementById('modal-recurrent-checkbox').checked;
            const frecuencia = document.getElementById('modal-frequency')?.value || 'semanal';
            const diasOrden = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

            // Validar fechas
            const fechaDesde = document.getElementById('specific-date-from').value;
            const fechaHasta = document.getElementById('specific-date-to').value;

            if (!fechaDesde || !fechaHasta) {
              Swal.showValidationMessage('Por favor selecciona el rango de fechas');
              return false;
            }

            // Auto-detectar vista bas√°ndose en el n√∫mero de d√≠as
            const from = new Date(fechaDesde);
            const to = new Date(fechaHasta);
            const diffTime = Math.abs(to - from);
            const days = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;
            const view = days === 7 ? 'week' : 'calendar';

            const horarios = [];

            if (view === 'week') {
              // Vista semanal: usar nombres de d√≠as
              diasOrden.forEach(dia => {
                // Turno 1
                const inicio = document.getElementById(`time-inicio-${dia}`)?.value;
                const fin = document.getElementById(`time-fin-${dia}`)?.value;
                const notas = document.getElementById(`time-notas-${dia}`)?.value || '';

                if (inicio && fin) {
                  horarios.push({
                    user_id: userId,
                    dia_semana: dia,
                    hora_inicio: inicio,
                    hora_fin: fin,
                    notas,
                    fecha_desde: fechaDesde,
                    fecha_hasta: fechaHasta,
                    es_recurrente: isRecurrent ? 1 : 0,
                    frecuencia_recurrencia: isRecurrent ? frecuencia : null
                  });
                }

                // Turno 2
                const inicio2 = document.getElementById(`time-inicio2-${dia}`)?.value;
                const fin2 = document.getElementById(`time-fin2-${dia}`)?.value;
                const notas2 = document.getElementById(`time-notas2-${dia}`)?.value || '';

                if (inicio2 && fin2) {
                  horarios.push({
                    user_id: userId,
                    dia_semana: dia,
                    hora_inicio: inicio2,
                    hora_fin: fin2,
                    notas: notas2,
                    fecha_desde: fechaDesde,
                    fecha_hasta: fechaHasta,
                    es_recurrente: isRecurrent ? 1 : 0,
                    frecuencia_recurrencia: isRecurrent ? frecuencia : null
                  });
                }
              });
            } else {
              // Vista mensual/trimestral
              const days = view === 'month' ? 30 : 90;

              for (let i = 0; i < days; i++) {
                const inicio = document.getElementById(`time-inicio-day${i}`)?.value;
                const fin = document.getElementById(`time-fin-day${i}`)?.value;
                const notas = document.getElementById(`time-notas-day${i}`)?.value || '';

                if (inicio && fin) {
                  const date = new Date();
                  date.setDate(date.getDate() + i);
                  const diaSemana = diasOrden[date.getDay() === 0 ? 6 : date.getDay() - 1];

                  horarios.push({
                    user_id: userId,
                    dia_semana: diaSemana,
                    hora_inicio: inicio,
                    hora_fin: fin,
                    notas,
                    fecha_desde: fechaDesde,
                    fecha_hasta: fechaHasta,
                    es_recurrente: isRecurrent ? 1 : 0,
                    frecuencia_recurrencia: isRecurrent ? frecuencia : null
                  });
                }
              }
            }

            if (horarios.length === 0) {
              Swal.showValidationMessage('Debes rellenar al menos un d√≠a con horario (inicio y fin)');
              return false;
            }

            return horarios;
          }
        });

        if (result.isConfirmed) {
          // Primero eliminar todos los horarios antiguos del empleado
          await fetch(`/api/horarios/user/${userId}`, { method: 'DELETE' });

          // Luego crear los nuevos
          let saved = 0;
          for (const horario of result.value) {
            try {
              await fetch('/api/horarios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(horario)
              });
              saved++;
            } catch (error) {
              console.error('Error guardando:', error);
            }
          }

          Swal.fire('¬°Actualizado!', `Se guardaron ${saved} horarios correctamente`, 'success');
          loadSchedulesList();
        }
      } catch (error) {
        console.error('Error:', error);
        Swal.fire('Error', 'No se pudo cargar los horarios', 'error');
      }
    }

    function toggleEditTurn2(dia) {
      const checkbox = document.getElementById(`edit-enable-turn2-${dia}`);
      const container = document.getElementById(`edit-turn2-container-${dia}`);

      if (checkbox && container) {
        if (checkbox.checked) {
          container.classList.remove('hidden');
        } else {
          container.classList.add('hidden');
          // Limpiar campos al desactivar
          document.getElementById(`edit-inicio2-${dia}`).value = '';
          document.getElementById(`edit-fin2-${dia}`).value = '';
          document.getElementById(`edit-notas2-${dia}`).value = '';
        }
      }
    }

    async function deleteSchedulesByEmployee() {
      const usersResponse = await fetch('/api/users');
      const allUsers = await usersResponse.json();
      const employees = allUsers.filter(u => u.rol !== 'admin');

      const { value: userId } = await Swal.fire({
        title: 'Selecciona un empleado',
        input: 'select',
        inputOptions: employees.reduce((obj, u) => {
          obj[u.id] = u.nombre;
          return obj;
        }, {}),
        inputPlaceholder: 'Selecciona un empleado',
        showCancelButton: true,
        confirmButtonText: 'Eliminar sus horarios',
        cancelButtonText: 'Cancelar'
      });

      if (userId) {
        const employee = employees.find(u => u.id === parseInt(userId));
        deleteEmployeeSchedules(userId, employee.nombre);
      }
    }

    async function showCreateScheduleModal() {
      const usersResponse = await fetch('/api/users');
      const allUsers = await usersResponse.json();
      const employees = allUsers.filter(u => u.rol !== 'admin');

      const diasOrden = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

      const result = await Swal.fire({
        title: 'üìÖ Crear Horarios',
        html: `
          <div class="text-left space-y-4">
            <!-- Selector de empleado -->
            <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
              <label class="block text-sm font-semibold mb-2">üë§ Empleado:</label>
              <select id="modal-user" class="w-full px-3 py-2 border rounded-lg mb-3">
                <option value="">Selecciona un empleado</option>
                ${employees.map(u => `<option value="${u.id}">${u.nombre}</option>`).join('')}
              </select>
              
              <!-- CHECKBOX para Horario Recurrente -->
              <div class="flex items-center p-3 bg-white rounded-lg border-2 border-blue-300">
                <input type="checkbox" id="modal-recurrent-checkbox" onchange="toggleRecurrentMode()" class="w-5 h-5 mr-3">
                <div class="flex-grow">
                  <label for="modal-recurrent-checkbox" class="font-bold text-blue-700 cursor-pointer">
                    üîÑ Horario Recurrente
                  </label>
                  <p class="text-xs text-slate-600 mt-1">El horario se repetir√° autom√°ticamente seg√∫n la frecuencia elegida</p>
                </div>
              </div>
              
              <!-- Selector de Frecuencia (solo visible cuando recurrente est√° activo) -->
              <div id="frequency-selector" class="mt-3 hidden">
                <label class="block text-sm font-semibold mb-2 text-blue-800">üîÅ Frecuencia de Repetici√≥n:</label>
                <select id="modal-frequency" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg bg-white focus:border-blue-500 font-medium">
                  <option value="semanal">üìÖ Semanal (se repite cada semana)</option>
                  <option value="quincenal">üìÜ Quincenal (se repite cada 2 semanas)</option>
                  <option value="mensual">üìÜ Mensual (se repite cada mes)</option>
                  <option value="trimestral">üìä Trimestral (se repite cada 3 meses)</option>
                  <option value="anual">üóìÔ∏è Anual (se repite cada a√±o)</option>
                </select>
                <p class="text-xs text-blue-600 mt-2 font-semibold">üí° El horario configurado se repetir√° con esta frecuencia durante todo el rango de fechas</p>
              </div>
            </div>

            <!-- Selector de fechas -->
            <div id="date-range-selector" class="bg-purple-50 p-3 rounded-lg border border-purple-200">
              <label class="block text-sm font-semibold mb-2">üìÖ Rango de Fechas:</label>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs text-gray-600">Desde:</label>
                  <input type="date" id="specific-date-from" onchange="updateCalendarWithDates()" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                  <label class="text-xs text-gray-600">Hasta:</label>
                  <input type="date" id="specific-date-to" onchange="updateCalendarWithDates()" class="w-full px-3 py-2 border rounded-lg">
                </div>
              </div>
              <p id="date-range-message" class="text-xs text-slate-600 mt-2">El horario solo aplica para este rango de fechas</p>
            </div>

            <!-- Calendario editable -->
            <div id="calendar-grid" class="bg-white border rounded-lg">
              <!-- Se genera din√°micamente -->
            </div>

            <div id="tip-message" class="bg-yellow-50 p-3 rounded-lg border border-yellow-300 text-sm">
              üí° <strong>Tip:</strong> Usa el bot√≥n ‚ö° para copiar un horario a todos los d√≠as. Deja vac√≠os los d√≠as libres.
            </div>
            
            <!-- Bot√≥n de copia r√°pida -->
            <div id="quick-copy-section" class="mt-3">
              <button type="button" onclick="quickCopyFirstDay()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                ‚ö° Copiar primer d√≠a a todos
              </button>
              <span class="text-xs text-gray-500 ml-2">Rellena el primer d√≠a con horario y haz clic aqu√≠</span>
            </div>
          </div>
        `,
        width: '95%',
        showCancelButton: true,
        confirmButtonText: '‚úÖ Guardar Horarios',
        cancelButtonText: '‚ùå Cancelar',
        confirmButtonColor: '#10b981',
        didOpen: () => {
          // Establecer fechas por defecto (7 d√≠as)
          const today = new Date();
          const endDate = new Date();
          endDate.setDate(today.getDate() + 6);
          document.getElementById('specific-date-from').valueAsDate = today;
          document.getElementById('specific-date-to').valueAsDate = endDate;

          // Generar calendario basado en las fechas
          generateCalendarView();

          // Actualizar UI seg√∫n el estado inicial (no recurrente)
          toggleRecurrentMode();
        },
        preConfirm: () => {
          const userId = document.getElementById('modal-user').value;
          if (!userId) {
            Swal.showValidationMessage('Por favor selecciona un empleado');
            return false;
          }

          const isRecurrent = document.getElementById('modal-recurrent-checkbox').checked;
          const frecuencia = document.getElementById('modal-frequency')?.value || 'semanal';
          const diasOrden = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

          // Validar fechas (necesarias en ambos modos)
          const fechaDesde = document.getElementById('specific-date-from').value;
          const fechaHasta = document.getElementById('specific-date-to').value;

          if (!fechaDesde || !fechaHasta) {
            Swal.showValidationMessage('Por favor selecciona el rango de fechas');
            return false;
          }

          // Auto-detectar vista bas√°ndose en el n√∫mero de d√≠as
          const from = new Date(fechaDesde);
          const to = new Date(fechaHasta);
          const diffTime = Math.abs(to - from);
          const days = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;
          const view = days === 7 ? 'week' : 'calendar';

          const horarios = [];

          console.log('üîç Buscando horarios. Vista:', view);

          if (view === 'week') {
            // Vista semanal: usar nombres de d√≠as
            diasOrden.forEach(dia => {
              // Turno 1
              const inicioEl = document.getElementById(`time-inicio-${dia}`);
              const finEl = document.getElementById(`time-fin-${dia}`);
              const inicio = inicioEl?.value;
              const fin = finEl?.value;
              const notas = document.getElementById(`time-notas-${dia}`)?.value || '';

              console.log(`üìÖ ${dia}: inicio=${inicio}, fin=${fin}, elemento=${inicioEl ? 'existe' : 'NO EXISTE'}`);

              if (inicio && fin) {
                console.log(`‚úÖ Horario a√±adido: ${dia} ${inicio}-${fin}`);
                horarios.push({
                  user_id: userId,
                  dia_semana: dia,
                  hora_inicio: inicio,
                  hora_fin: fin,
                  notas,
                  fecha_desde: fechaDesde,
                  fecha_hasta: fechaHasta,
                  es_recurrente: isRecurrent ? 1 : 0,
                  frecuencia_recurrencia: isRecurrent ? frecuencia : null
                });
              }

              // Turno 2 (si existe)
              const inicio2El = document.getElementById(`time-inicio2-${dia}`);
              const fin2El = document.getElementById(`time-fin2-${dia}`);
              const inicio2 = inicio2El?.value;
              const fin2 = fin2El?.value;
              const notas2 = document.getElementById(`time-notas2-${dia}`)?.value || '';

              if (inicio2 && fin2) {
                console.log(`‚úÖ Horario 2 a√±adido: ${dia} ${inicio2}-${fin2}`);
                horarios.push({
                  user_id: userId,
                  dia_semana: dia,
                  hora_inicio: inicio2,
                  hora_fin: fin2,
                  notas: notas2,
                  fecha_desde: fechaDesde,
                  fecha_hasta: fechaHasta,
                  es_recurrente: isRecurrent ? 1 : 0,
                  frecuencia_recurrencia: isRecurrent ? frecuencia : null
                });
              }
            });
          } else {
            // Vista mensual/trimestral: usar √≠ndices num√©ricos
            const days = view === 'month' ? 30 : 90;
            console.log('D√≠as a revisar:', days);

            for (let i = 0; i < days; i++) {
              const inicioEl = document.getElementById(`time-inicio-day${i}`);
              const finEl = document.getElementById(`time-fin-day${i}`);
              const inicio = inicioEl?.value;
              const fin = finEl?.value;
              const notas = document.getElementById(`time-notas-day${i}`)?.value || '';

              if (inicio && fin) {
                const date = new Date();
                date.setDate(date.getDate() + i);
                const diaSemana = diasOrden[date.getDay() === 0 ? 6 : date.getDay() - 1];

                console.log(`‚úÖ Horario a√±adido d√≠a ${i}: ${diaSemana} ${inicio}-${fin}`);

                horarios.push({
                  user_id: userId,
                  dia_semana: diaSemana,
                  hora_inicio: inicio,
                  hora_fin: fin,
                  notas,
                  fecha_desde: fechaDesde,
                  fecha_hasta: fechaHasta,
                  es_recurrente: isRecurrent ? 1 : 0,
                  frecuencia_recurrencia: isRecurrent ? frecuencia : null
                });
              }
            }
          }

          console.log(`üìä Total horarios encontrados: ${horarios.length}`);

          if (horarios.length === 0) {
            Swal.showValidationMessage('Debes rellenar al menos un d√≠a con horario (inicio y fin)');
            return false;
          }

          return horarios;
        }
      });

      if (result.isConfirmed) {
        let saved = 0;
        for (const horario of result.value) {
          try {
            await fetch('/api/horarios', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(horario)
            });
            saved++;
          } catch (error) {
            console.error('Error guardando:', error);
          }
        }

        Swal.fire('¬°Creados!', `Se guardaron ${saved} horarios correctamente`, 'success');
        loadSchedulesList();
      }
    }

    function generateCalendarView() {
      const container = document.getElementById('calendar-grid');
      const diasOrden = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
      const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

      const isRecurrent = document.getElementById('modal-recurrent-checkbox')?.checked === true;

      // Obtener fechas del selector
      const fechaDesdeInput = document.getElementById('specific-date-from');
      const fechaHastaInput = document.getElementById('specific-date-to');

      let fechaDesde, fechaHasta;

      if (fechaDesdeInput && fechaDesdeInput.value && fechaHastaInput && fechaHastaInput.value) {
        fechaDesde = new Date(fechaDesdeInput.value + 'T00:00:00');
        fechaHasta = new Date(fechaHastaInput.value + 'T00:00:00');
      } else {
        // Si no hay fechas, usar valores por defecto (7 d√≠as)
        fechaDesde = new Date();
        fechaHasta = new Date();
        fechaHasta.setDate(fechaDesde.getDate() + 6);
      }

      // Calcular n√∫mero de d√≠as entre las fechas (incluir ambos extremos)
      const diffTime = fechaHasta.getTime() - fechaDesde.getTime();
      const days = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;

      // Determinar qu√© vista usar seg√∫n el n√∫mero de d√≠as
      if (days === 7) {
        // Vista semanal
        container.innerHTML = `
          <div class="bg-cyan-50 rounded-lg p-4 border-2 border-cyan-200">
            <h3 id="weekly-schedule-title" class="text-lg font-bold text-cyan-800 mb-3 text-center">üìÖ Horario Semanal${isRecurrent ? ' Recurrente' : ''}</h3>
            <div class="grid grid-cols-7 gap-2">
              ${diasOrden.map(dia => `
                <div class="border-2 rounded-lg overflow-hidden bg-white shadow-sm border-cyan-300">
                  <div class="bg-gradient-to-r from-cyan-600 to-cyan-700 text-white text-center py-2 font-bold text-sm">
                    ${dia}
                  </div>
                  <div class="p-2 space-y-2">
                    <!-- Turno 1 -->
                    <div class="bg-cyan-50 p-2 rounded border-2 border-cyan-200">
                      <p class="text-xs font-bold text-cyan-700 mb-1">‚è∞ Turno 1:</p>
                      <input type="time" id="time-inicio-${dia}" placeholder="Inicio" class="w-full text-xs p-1 border-2 rounded focus:border-cyan-500 mb-1">
                      <input type="time" id="time-fin-${dia}" placeholder="Fin" class="w-full text-xs p-1 border-2 rounded focus:border-cyan-500 mb-1">
                      <input type="text" id="time-notas-${dia}" placeholder="Notas (opcional)" class="w-full text-xs p-1 border-2 rounded focus:border-cyan-500">
                    </div>
                    
                    <!-- Checkbox para activar Turno 2 -->
                    <div class="text-center">
                      <label class="inline-flex items-center cursor-pointer text-xs">
                        <input type="checkbox" id="enable-turn2-${dia}" onchange="toggleTurn2('${dia}')" class="mr-1">
                        <span class="font-semibold text-orange-700">üîÑ Doble Turno</span>
                      </label>
                    </div>
                    
                    <!-- Turno 2 (oculto por defecto) -->
                    <div id="turn2-container-${dia}" class="bg-orange-50 p-2 rounded border-2 border-orange-300 hidden">
                      <p class="text-xs font-bold text-orange-700 mb-1">‚è∞ Turno 2:</p>
                      <input type="time" id="time-inicio2-${dia}" placeholder="Inicio" class="w-full text-xs p-1 border-2 rounded focus:border-orange-500 mb-1">
                      <input type="time" id="time-fin2-${dia}" placeholder="Fin" class="w-full text-xs p-1 border-2 rounded focus:border-orange-500 mb-1">
                      <input type="text" id="time-notas2-${dia}" placeholder="Notas" class="w-full text-xs p-1 border-2 rounded focus:border-orange-500">
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      } else {
        // Vista de calendario mensual/trimestral/personalizada
        // Nota: aqu√≠ reutilizamos fechaDesde/fechaHasta calculadas al inicio.

        // Agrupar d√≠as por mes
        const diasPorMes = {};
        for (let i = 0; i < days; i++) {
          const date = new Date(fechaDesde);
          date.setDate(date.getDate() + i);
          const mesKey = `${date.getFullYear()}-${date.getMonth()}`;
          const mesNombre = mesesNombres[date.getMonth()];
          const year = date.getFullYear();

          if (!diasPorMes[mesKey]) {
            diasPorMes[mesKey] = {
              nombre: mesNombre,
              year: year,
              dias: []
            };
          }
          diasPorMes[mesKey].dias.push({ date, index: i });
        }

        container.innerHTML = `
          <div class="space-y-4 max-h-[60vh] overflow-y-auto">
            ${Object.entries(diasPorMes).map(([key, mesData]) => `
              <div class="bg-white rounded-lg border-2 border-slate-300 overflow-hidden shadow-lg">
                <!-- Header del mes -->
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-3 flex justify-between items-center">
                  <h3 class="text-lg font-bold">üìÖ ${mesData.nombre.toUpperCase()} ${mesData.year}</h3>
                  <span class="bg-white text-blue-700 px-3 py-1 rounded-full text-sm font-bold">
                    ${mesData.dias.length} d√≠as
                  </span>
                </div>
                
                <!-- Encabezados de d√≠as de la semana -->
                <div class="grid grid-cols-7 bg-slate-100 border-b-2 border-slate-300">
                  ${['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'].map(d => `
                    <div class="text-center py-2 font-bold text-slate-700 text-xs">${d}</div>
                  `).join('')}
                </div>
                
                <!-- Grid de d√≠as -->
                <div class="grid grid-cols-7 gap-0 bg-slate-50">
                  ${mesData.dias.map(({ date, index }) => {
          const dayName = diasOrden[date.getDay() === 0 ? 6 : date.getDay() - 1];
          const dayNum = date.getDate();
          const isToday = date.toDateString() === new Date().toDateString();

          return `
                      <div class="border border-slate-200 p-1 bg-white hover:bg-blue-50 transition ${isToday ? 'ring-2 ring-emerald-500 bg-emerald-50' : ''}">
                        <div class="text-center mb-1">
                          <span class="text-xs font-bold ${isToday ? 'text-emerald-700' : 'text-slate-700'}">${dayNum}</span>
                          ${isToday ? '<p class="text-xs text-emerald-600 font-bold">HOY</p>' : ''}
                        </div>
                        <input type="time" id="time-inicio-day${index}" title="${dayName} ${dayNum}" class="w-full text-xs p-1 border rounded mb-1 focus:border-blue-500" placeholder="Inicio">
                        <input type="time" id="time-fin-day${index}" class="w-full text-xs p-1 border rounded mb-1 focus:border-blue-500" placeholder="Fin">
                        <input type="text" id="time-notas-day${index}" placeholder="N" class="w-full text-xs p-1 border rounded focus:border-blue-500" title="Notas">
                      </div>
                    `;
        }).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }
    }

    function updateCalendarWithDates() {
      // Regenerar calendario cuando cambian las fechas
      generateCalendarView();
    }

    function quickCopyFirstDay() {
      const diasOrden = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

      // Detectar si es vista semanal revisando si existen los IDs de d√≠a con nombre
      const esVistaSemanal = document.getElementById('time-inicio-Lunes') !== null;

      if (esVistaSemanal) {
        // Vista semanal: copiar Lunes a todos los dem√°s
        const firstInicio = document.getElementById('time-inicio-Lunes')?.value;
        const firstFin = document.getElementById('time-fin-Lunes')?.value;
        const firstNotas = document.getElementById('time-notas-Lunes')?.value || '';

        if (!firstInicio || !firstFin) {
          Swal.fire({
            icon: 'warning',
            title: 'Atenci√≥n',
            text: 'Por favor, primero rellena el horario del Lunes (inicio y fin)',
            confirmButtonText: 'OK'
          });
          return;
        }

        // Mostrar modal con selecci√≥n de d√≠as
        const checkboxesHtml = diasOrden.slice(1).map((dia, index) => `
          <div class="flex items-center p-3 rounded-lg border-2 border-blue-200 bg-blue-50 hover:bg-blue-100 transition-colors">
            <input type="checkbox" id="copy-${dia}" checked class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 mr-3">
            <label for="copy-${dia}" class="text-base font-semibold text-gray-800 cursor-pointer flex-grow">
              üìÖ ${dia}
            </label>
          </div>
        `).join('');

        Swal.fire({
          title: '‚ö° Copiar Horario del Lunes',
          html: `
            <div class="text-left">
              <div class="bg-green-100 border-2 border-green-400 rounded-lg p-3 mb-4">
                <p class="text-sm font-bold text-green-800 mb-1">üìã Horario a copiar:</p>
                <p class="text-sm text-green-700">‚è∞ <strong>${firstInicio}</strong> - <strong>${firstFin}</strong></p>
                ${firstNotas ? `<p class="text-xs text-green-600 mt-1">üìù ${firstNotas}</p>` : ''}
              </div>
              
              <p class="text-sm font-semibold text-gray-700 mb-3">Selecciona los d√≠as donde quieres copiar este horario:</p>
              
              <div class="space-y-2 max-h-96 overflow-y-auto">
                <div class="flex items-center justify-between p-2 bg-gradient-to-r from-purple-100 to-purple-50 rounded-lg border-2 border-purple-300 mb-3">
                  <button type="button" onclick="document.querySelectorAll('[id^=copy-]').forEach(cb => cb.checked = true)" class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded-lg text-xs font-bold transition-colors">
                    ‚úÖ Marcar Todos
                  </button>
                  <button type="button" onclick="document.querySelectorAll('[id^=copy-]').forEach(cb => cb.checked = false)" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs font-bold transition-colors">
                    ‚ùå Desmarcar Todos
                  </button>
                </div>
                ${checkboxesHtml}
              </div>
            </div>
          `,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: '‚úÖ Copiar a seleccionados',
          cancelButtonText: '‚ùå Cancelar',
          customClass: {
            popup: 'w-full max-w-md',
            confirmButton: 'bg-green-500 hover:bg-green-600',
            cancelButton: 'bg-gray-500 hover:bg-gray-600'
          },
          preConfirm: () => {
            const selectedDays = diasOrden.slice(1).filter(dia =>
              document.getElementById(`copy-${dia}`)?.checked
            );

            if (selectedDays.length === 0) {
              Swal.showValidationMessage('Por favor, selecciona al menos un d√≠a');
              return false;
            }

            return selectedDays;
          }
        }).then((result) => {
          if (result.isConfirmed && result.value) {
            let copiedCount = 0;
            result.value.forEach(dia => {
              const inicioInput = document.getElementById(`time-inicio-${dia}`);
              const finInput = document.getElementById(`time-fin-${dia}`);
              const notasInput = document.getElementById(`time-notas-${dia}`);

              if (inicioInput && finInput) {
                inicioInput.value = firstInicio;
                finInput.value = firstFin;
                if (notasInput) notasInput.value = firstNotas;
                copiedCount++;
              }
            });

            Swal.fire({
              icon: 'success',
              title: '¬°Copiado!',
              text: `Horario del Lunes copiado a ${copiedCount} d√≠a${copiedCount !== 1 ? 's' : ''}`,
              timer: 1500,
              showConfirmButton: false
            });
          }
        });
      } else {
        // Vista de calendario: copiar day0 a todos
        const firstInicio = document.getElementById('time-inicio-day0')?.value;
        const firstFin = document.getElementById('time-fin-day0')?.value;
        const firstNotas = document.getElementById('time-notas-day0')?.value || '';

        if (!firstInicio || !firstFin) {
          Swal.fire({
            icon: 'warning',
            title: 'Atenci√≥n',
            text: 'Por favor, primero rellena el horario del primer d√≠a (inicio y fin)',
            confirmButtonText: 'OK'
          });
          return;
        }

        // Contar cu√°ntos d√≠as hay en total
        let totalDays = 0;
        let dayNames = [];
        const fechaDesdeInput = document.getElementById('specific-date-from');
        const startDate = fechaDesdeInput ? new Date(fechaDesdeInput.value + 'T00:00:00') : new Date();

        while (document.getElementById(`time-inicio-day${totalDays}`)) {
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + totalDays);
          const dayName = currentDate.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
          dayNames.push({ index: totalDays, name: dayName });
          totalDays++;
        }

        // Mostrar modal con selecci√≥n de d√≠as
        const checkboxesHtml = dayNames.slice(1).map(({ index, name }) => `
          <div class="flex items-center p-3 rounded-lg border-2 border-blue-200 bg-blue-50 hover:bg-blue-100 transition-colors">
            <input type="checkbox" id="copy-day${index}" checked class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 mr-3">
            <label for="copy-day${index}" class="text-base font-semibold text-gray-800 cursor-pointer flex-grow">
              üìÖ ${name}
            </label>
          </div>
        `).join('');

        Swal.fire({
          title: '‚ö° Copiar Horario del Primer D√≠a',
          html: `
            <div class="text-left">
              <div class="bg-green-100 border-2 border-green-400 rounded-lg p-3 mb-4">
                <p class="text-sm font-bold text-green-800 mb-1">üìã Horario a copiar:</p>
                <p class="text-sm text-green-700">‚è∞ <strong>${firstInicio}</strong> - <strong>${firstFin}</strong></p>
                ${firstNotas ? `<p class="text-xs text-green-600 mt-1">üìù ${firstNotas}</p>` : ''}
              </div>
              
              <p class="text-sm font-semibold text-gray-700 mb-3">Selecciona los d√≠as donde quieres copiar este horario:</p>
              
              <div class="space-y-2 max-h-96 overflow-y-auto">
                <div class="flex items-center justify-between p-2 bg-gradient-to-r from-purple-100 to-purple-50 rounded-lg border-2 border-purple-300 mb-3">
                  <button type="button" onclick="document.querySelectorAll('[id^=copy-day]').forEach(cb => cb.checked = true)" class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded-lg text-xs font-bold transition-colors">
                    ‚úÖ Marcar Todos
                  </button>
                  <button type="button" onclick="document.querySelectorAll('[id^=copy-day]').forEach(cb => cb.checked = false)" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs font-bold transition-colors">
                    ‚ùå Desmarcar Todos
                  </button>
                </div>
                ${checkboxesHtml}
              </div>
            </div>
          `,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: '‚úÖ Copiar a seleccionados',
          cancelButtonText: '‚ùå Cancelar',
          customClass: {
            popup: 'w-full max-w-md',
            confirmButton: 'bg-green-500 hover:bg-green-600',
            cancelButton: 'bg-gray-500 hover:bg-gray-600'
          },
          preConfirm: () => {
            const selectedDays = dayNames.slice(1).filter(({ index }) =>
              document.getElementById(`copy-day${index}`)?.checked
            ).map(({ index }) => index);

            if (selectedDays.length === 0) {
              Swal.showValidationMessage('Por favor, selecciona al menos un d√≠a');
              return false;
            }

            return selectedDays;
          }
        }).then((result) => {
          if (result.isConfirmed && result.value) {
            let copiedCount = 0;
            result.value.forEach(dayIndex => {
              const inicioInput = document.getElementById(`time-inicio-day${dayIndex}`);
              const finInput = document.getElementById(`time-fin-day${dayIndex}`);
              const notasInput = document.getElementById(`time-notas-day${dayIndex}`);

              if (inicioInput && finInput) {
                inicioInput.value = firstInicio;
                finInput.value = firstFin;
                if (notasInput) notasInput.value = firstNotas;
                copiedCount++;
              }
            });

            Swal.fire({
              icon: 'success',
              title: '¬°Copiado!',
              text: `Horario copiado a ${copiedCount} d√≠a${copiedCount !== 1 ? 's' : ''}`,
              timer: 1500,
              showConfirmButton: false
            });
          }
        });
      }
    }

    function toggleRecurrentMode() {
      const isRecurrent = document.getElementById('modal-recurrent-checkbox').checked;
      const dateRangeSelector = document.getElementById('date-range-selector');
      const frequencySelector = document.getElementById('frequency-selector');
      const tipMessage = document.getElementById('tip-message');
      const dateLabel = dateRangeSelector.querySelector('label.block');
      const dateRangeMessage = document.getElementById('date-range-message');
      const weeklyTitle = document.getElementById('weekly-schedule-title');

      // Siempre mostrar el selector de fechas
      dateRangeSelector.classList.remove('hidden');

      if (isRecurrent) {
        // Modo recurrente: mostrar selector de frecuencia y cambiar textos
        frequencySelector.classList.remove('hidden');
        dateLabel.innerHTML = 'üîÅ Per√≠odo de Recurrencia:';
        dateRangeMessage.innerHTML = 'üîÑ El horario se repetir√° autom√°ticamente durante este per√≠odo';
        tipMessage.innerHTML = 'üí° <strong>Tip:</strong> Este horario se repetir√° autom√°ticamente seg√∫n la frecuencia elegida. Deja vac√≠os los d√≠as libres.';
      } else {
        // Modo espec√≠fico: ocultar selector de frecuencia y texto normal
        frequencySelector.classList.add('hidden');
        dateLabel.innerHTML = 'üìÖ Rango de Fechas:';
        dateRangeMessage.innerHTML = 'üìÜ El horario solo aplica para este rango de fechas (no se repite)';
        tipMessage.innerHTML = 'üí° <strong>Tip:</strong> Usa el bot√≥n ‚ö° para copiar un horario a todos los d√≠as. Deja vac√≠os los d√≠as libres.';
      }

      // Evitar que el t√≠tulo diga "Recurrente" si no est√° marcado
      if (weeklyTitle) {
        weeklyTitle.textContent = `üìÖ Horario Semanal${isRecurrent ? ' Recurrente' : ''}`;
      }
    }

    function generateWeekCalendar() {
      const container = document.getElementById('week-calendar-grid');
      const diasOrden = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

      container.innerHTML = `
        <div class="grid grid-cols-7 gap-2">
          ${diasOrden.map(dia => `
            <div class="border-2 rounded-lg overflow-hidden bg-white shadow-sm border-cyan-300">
              <div class="bg-gradient-to-r from-cyan-600 to-cyan-700 text-white text-center py-2 font-bold text-sm">
                ${dia}
              </div>
              <div class="p-2 space-y-2">
                <!-- Turno 1 -->
                <div class="bg-cyan-50 p-2 rounded border-2 border-cyan-200">
                  <p class="text-xs font-bold text-cyan-700 mb-1">‚è∞ Turno 1:</p>
                  <input type="time" id="week-time-inicio-${dia}" placeholder="Inicio" class="w-full text-xs p-1 border-2 rounded focus:border-cyan-500 mb-1">
                  <input type="time" id="week-time-fin-${dia}" placeholder="Fin" class="w-full text-xs p-1 border-2 rounded focus:border-cyan-500 mb-1">
                  <input type="text" id="week-time-notas-${dia}" placeholder="Notas (opcional)" class="w-full text-xs p-1 border-2 rounded focus:border-cyan-500">
                </div>
                
                <!-- Checkbox para activar Turno 2 -->
                <div class="text-center">
                  <label class="inline-flex items-center cursor-pointer text-xs">
                    <input type="checkbox" id="week-enable-turn2-${dia}" onchange="toggleWeekTurn2('${dia}')" class="mr-1">
                    <span class="font-semibold text-orange-700">üîÑ Doble Turno</span>
                  </label>
                </div>
                
                <!-- Turno 2 (oculto por defecto) -->
                <div id="week-turn2-container-${dia}" class="bg-orange-50 p-2 rounded border-2 border-orange-300 hidden">
                  <p class="text-xs font-bold text-orange-700 mb-1">‚è∞ Turno 2:</p>
                  <input type="time" id="week-time-inicio2-${dia}" placeholder="Inicio" class="w-full text-xs p-1 border-2 rounded focus:border-orange-500 mb-1">
                  <input type="time" id="week-time-fin2-${dia}" placeholder="Fin" class="w-full text-xs p-1 border-2 rounded focus:border-orange-500 mb-1">
                  <input type="text" id="week-time-notas2-${dia}" placeholder="Notas" class="w-full text-xs p-1 border-2 rounded focus:border-orange-500">
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function toggleWeekTurn2(dia) {
      const checkbox = document.getElementById(`week-enable-turn2-${dia}`);
      const container = document.getElementById(`week-turn2-container-${dia}`);

      if (checkbox && container) {
        if (checkbox.checked) {
          container.classList.remove('hidden');
        } else {
          container.classList.add('hidden');
          document.getElementById(`week-time-inicio2-${dia}`).value = '';
          document.getElementById(`week-time-fin2-${dia}`).value = '';
          document.getElementById(`week-time-notas2-${dia}`).value = '';
        }
      }
    }

    function toggleScheduleType() {
      // Esta funci√≥n ya no se usa, pero la dejo para compatibilidad
    }

    function toggleSpecificDay(dia) {
      // Esta funci√≥n ya no se usa, pero la dejo para compatibilidad
    }

    function toggleTurn2(dia) {
      const checkbox = document.getElementById(`enable-turn2-${dia}`);
      const container = document.getElementById(`turn2-container-${dia}`);

      if (checkbox && container) {
        if (checkbox.checked) {
          container.classList.remove('hidden');
        } else {
          container.classList.add('hidden');
          // Limpiar campos al desactivar
          document.getElementById(`time-inicio2-${dia}`).value = '';
          document.getElementById(`time-fin2-${dia}`).value = '';
          document.getElementById(`time-notas2-${dia}`).value = '';
        }
      }
    }

    function deleteSchedule(id) {
      Swal.fire({
        title: '¬øEliminar horario?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const response = await fetch(`/api/horarios/${id}`, { method: 'DELETE' });
            if (response.ok) {
              Swal.fire('¬°Eliminado!', 'Horario eliminado', 'success');
              loadSchedulesList();
            }
          } catch (error) {
            Swal.fire('Error', 'No se pudo eliminar', 'error');
          }
        }
      });
    }

    async function uploadScheduleImage() {
      const fileInput = document.getElementById('schedule-image');

      if (!fileInput.files[0]) {
        Swal.fire('Error', 'Por favor selecciona una imagen', 'error');
        return;
      }

      Swal.fire({
        title: 'Procesando imagen...',
        text: 'La IA est√° analizando el horario',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      try {
        const formData = new FormData();
        formData.append('image', fileInput.files[0]);

        const response = await fetch('/api/horarios/upload', {
          method: 'POST',
          body: formData
        });

        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);

        if (!response.ok) {
          console.error('Error en respuesta:', data);
          throw new Error(data.details || data.error);
        }

        // Mostrar los horarios detectados y permitir modificarlos
        if (data.horarios.length === 0) {
          Swal.fire('Sin resultados', 'No se detectaron horarios en la imagen', 'warning');
          return;
        }

        // Obtener usuarios para hacer match
        const usersResponse = await fetch('/api/users');
        const allUsers = await usersResponse.json();

        // Mostrar cada horario detectado para confirmaci√≥n individual
        await processDetectedSchedules(data.horarios, allUsers);

      } catch (error) {
        Swal.fire('Error', error.message || 'No se pudo procesar la imagen', 'error');
      }
    }

    async function processDetectedSchedules(horarios, allUsers) {
      // Crear estructura de calendario editable
      const diasOrden = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

      // Agrupar por empleado
      const horariosPorEmpleado = {};
      horarios.forEach(h => {
        if (!horariosPorEmpleado[h.empleado]) {
          horariosPorEmpleado[h.empleado] = {};
          diasOrden.forEach(dia => horariosPorEmpleado[h.empleado][dia] = null);
        }
        horariosPorEmpleado[h.empleado][h.dia_semana] = h;
      });

      // Generar HTML del calendario
      let calendarHTML = '<div class="space-y-6 max-h-[70vh] overflow-y-auto px-2">';

      for (const [empleadoNombre, diasHorarios] of Object.entries(horariosPorEmpleado)) {
        // Buscar usuario coincidente
        const matchedUser = allUsers.find(u =>
          u.nombre.toLowerCase().includes(empleadoNombre.toLowerCase()) ||
          empleadoNombre.toLowerCase().includes(u.nombre.toLowerCase())
        );

        const empleadoId = `emp-${empleadoNombre.replace(/\s+/g, '-')}`;

        calendarHTML += `
          <div class="bg-white rounded-lg border-2 ${matchedUser ? 'border-green-300' : 'border-red-300'} p-4">
            <div class="mb-3">
              <div class="flex items-center justify-between mb-2">
                <label class="font-bold text-gray-700">
                  ${matchedUser ? '‚úÖ' : '‚ùå'} Empleado:
                </label>
                <select id="user-${empleadoId}" class="px-3 py-1 border rounded-lg font-semibold">
                  ${allUsers.filter(u => u.rol !== 'admin').map(u =>
          `<option value="${u.id}" ${matchedUser && u.id === matchedUser.id ? 'selected' : ''}>${u.nombre}</option>`
        ).join('')}
                </select>
              </div>
            </div>
            
            <div class="grid grid-cols-7 gap-2">
              ${diasOrden.map(dia => {
          const horario = diasHorarios[dia];
          const cellId = `${empleadoId}-${dia}`;

          return `
                  <div class="border rounded-lg overflow-hidden ${horario ? 'bg-blue-50 border-blue-300' : 'bg-gray-50 border-gray-300'}">
                    <div class="bg-gray-700 text-white text-center py-1 text-xs font-bold">
                      ${dia.substring(0, 3)}
                    </div>
                    <div class="p-2">
                      <input type="time" 
                             id="inicio-${cellId}" 
                             value="${horario?.hora_inicio || ''}" 
                             placeholder="Inicio"
                             class="w-full text-xs p-1 border rounded mb-1">
                      <input type="time" 
                             id="fin-${cellId}" 
                             value="${horario?.hora_fin || ''}" 
                             placeholder="Fin"
                             class="w-full text-xs p-1 border rounded mb-1">
                      <input type="text" 
                             id="notas-${cellId}" 
                             value="${horario?.notas || ''}" 
                             placeholder="Notas"
                             class="w-full text-xs p-1 border rounded">
                    </div>
                  </div>
                `;
        }).join('')}
            </div>
          </div>
        `;
      }

      calendarHTML += '</div>';

      // Mostrar modal con calendario editable
      const result = await Swal.fire({
        title: 'üìÖ Horarios Detectados - Edita y Guarda',
        html: calendarHTML,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: '‚úÖ Guardar Todos',
        cancelButtonText: '‚ùå Cancelar',
        confirmButtonColor: '#10b981',
        width: '95%',
        customClass: {
          popup: 'text-left',
          htmlContainer: 'px-2'
        }
      });

      if (result.isConfirmed) {
        let saved = 0;
        let errors = 0;

        // Guardar todos los horarios
        for (const [empleadoNombre, diasHorarios] of Object.entries(horariosPorEmpleado)) {
          const empleadoId = `emp-${empleadoNombre.replace(/\s+/g, '-')}`;
          const userId = document.getElementById(`user-${empleadoId}`).value;

          for (const dia of diasOrden) {
            const cellId = `${empleadoId}-${dia}`;
            const hora_inicio = document.getElementById(`inicio-${cellId}`).value;
            const hora_fin = document.getElementById(`fin-${cellId}`).value;
            const notas = document.getElementById(`notas-${cellId}`).value;

            // Solo guardar si tiene horarios
            if (hora_inicio && hora_fin) {
              try {
                await fetch('/api/horarios', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    user_id: userId,
                    dia_semana: dia,
                    hora_inicio,
                    hora_fin,
                    notas
                  })
                });
                saved++;
              } catch (error) {
                console.error('Error guardando:', error);
                errors++;
              }
            }
          }
        }

        Swal.fire({
          title: '¬°Completado!',
          html: `
            <div class="text-lg">
              <p>‚úÖ <strong>Guardados:</strong> ${saved}</p>
              ${errors > 0 ? `<p>‚ùå <strong>Errores:</strong> ${errors}</p>` : ''}
            </div>
          `,
          icon: 'success'
        });

        loadSchedulesList();
      }

      // Limpiar campo
      document.getElementById('schedule-image').value = '';
    }

    function updateMapAdmin() {
      const lat = document.getElementById('configLat').value;
      const lon = document.getElementById('configLon').value;

      if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
        const mapPreview = document.getElementById('map-preview-admin');
        if (mapPreview) {
          mapPreview.innerHTML = `
            <iframe 
              width="100%" 
              height="300" 
              frameborder="0" 
              style="border:0; border-radius: 8px;" 
              src="https://www.google.com/maps?q=${lat},${lon}&z=18&output=embed"
              allowfullscreen>
            </iframe>
          `;
        }
      }
    }

    async function applyAddress() {
      const address = document.getElementById('configAddress').value.trim();

      if (!address) {
        Swal.fire({
          icon: 'warning',
          title: 'Atenci√≥n',
          text: 'Por favor introduce una direcci√≥n'
        });
        return;
      }

      Swal.fire({
        title: 'Buscando direcci√≥n...',
        text: 'Por favor espera',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      try {
        // Usar API de Nominatim (OpenStreetMap) para geocodificar
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
        const data = await response.json();

        if (data && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);

          document.getElementById('configLat').value = lat;
          document.getElementById('configLon').value = lon;

          updateMapAdmin();

          Swal.fire({
            icon: 'success',
            title: '¬°Encontrado!',
            text: 'Direcci√≥n localizada. No olvides guardar la configuraci√≥n.',
            confirmButtonColor: '#0891b2'
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'No encontrado',
            text: 'No se pudo encontrar la direcci√≥n. Intenta con m√°s detalles (ciudad, c√≥digo postal, etc.)'
          });
        }
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Error al buscar la direcci√≥n: ' + error.message
        });
      }
    }

    async function useCurrentLocation() {
      if (!navigator.geolocation) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Tu navegador no soporta geolocalizaci√≥n'
        });
        return;
      }

      Swal.fire({
        title: 'Obteniendo ubicaci√≥n...',
        text: 'Por favor espera',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude.toFixed(6);
          const lon = position.coords.longitude.toFixed(6);
          document.getElementById('configLat').value = lat;
          document.getElementById('configLon').value = lon;
          updateMapAdmin();
          Swal.fire({
            icon: 'success',
            title: '¬°Ubicaci√≥n obtenida!',
            text: 'Ahora haz click en "Guardar Configuraci√≥n"',
            confirmButtonColor: '#16a34a'
          });
        },
        (error) => {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo obtener la ubicaci√≥n: ' + error.message
          });
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    async function saveConfig() {
      const lat = parseFloat(document.getElementById('configLat')?.value || 0);
      const lon = parseFloat(document.getElementById('configLon')?.value || 0);
      const maxDistance = parseInt(document.getElementById('configDistance')?.value || 50);
      const address = document.getElementById('configAddress')?.value?.trim() || '';
      const metodo_fichaje = document.querySelector('input[name="metodo_fichaje"]:checked')?.value || 'gps';
      const qr_duracion = parseInt(document.getElementById('configQrDuracion')?.value || 60);
      const qr_pin = document.getElementById('configQrPin')?.value || '1234';
      const require_photo = document.getElementById('configRequirePhoto')?.checked || false;

      try {
        const response = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat, lon, maxDistance, address, metodo_fichaje, qr_duracion, qr_pin, require_photo })
        });

        const data = await response.json();

        if (response.ok) {
          Swal.fire({
            icon: 'success',
            title: '¬°Guardado!',
            text: 'Configuraci√≥n actualizada correctamente',
            confirmButtonColor: '#16a34a'
          }).then(() => {
            renderAdmin();
          });
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: (error && error.message) ? error.message : 'No se pudo guardar la configuraci√≥n'
        });
      }
    }

    async function resetConfig() {
      const confirm = await Swal.fire({
        title: '¬øResetear Configuraci√≥n?',
        text: 'Esto pondr√° todos los valores por defecto',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#f97316',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'S√≠, resetear',
        cancelButtonText: 'Cancelar'
      });

      if (!confirm.isConfirmed) return;

      try {
        const response = await fetch('/api/config/reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();

        if (response.ok) {
          Swal.fire({
            icon: 'success',
            title: '¬°Resetado!',
            text: 'La configuraci√≥n ha sido resetada a valores por defecto',
            confirmButtonColor: '#16a34a'
          }).then(() => {
            renderAdmin();
          });
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: (error && error.message) ? error.message : 'No se pudo resetear la configuraci√≥n'
        });
      }
    }

    function exportToCSV() {
      fetch('/api/logs')
        .then(res => res.json())
        .then(logs => {
          const csv = [
            ['ID', 'Empleado', 'Tipo', 'Fecha', 'Hora', 'Latitud', 'Longitud'],
            ...logs.map(log => {
              const fecha = new Date(log.fecha);
              return [
                log.id,
                log.nombre,
                log.tipo,
                fecha.toLocaleDateString('es-ES'),
                fecha.toLocaleTimeString('es-ES'),
                log.lat,
                log.lon
              ];
            })
          ].map(row => row.join(',')).join('\n');

          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `fichajes_${new Date().toISOString().split('T')[0]}.csv`;
          link.click();
        });
    }

    // Variables globales para logs
    let allLogs = [];
    let filteredLogs = [];

    async function loadLogsData() {
      try {
        const response = await fetch('/api/logs');
        allLogs = await response.json();
        filteredLogs = [...allLogs];

        // Cargar empleados en el filtro
        const filterEmployee = document.getElementById('filter-log-employee');
        if (filterEmployee) {
          const uniqueEmployees = [...new Set(allLogs.map(log => log.nombre))];
          filterEmployee.innerHTML = '<option value="">Todos los empleados</option>' +
            uniqueEmployees.map(name => `<option value="${name}">${name}</option>`).join('');
        }

        renderLogsTable();
        updateLogStats();
      } catch (error) {
        console.error('Error cargando logs:', error);
      }
    }

    function filterLogs() {
      const employeeFilter = document.getElementById('filter-log-employee')?.value || '';
      const typeFilter = document.getElementById('filter-log-type')?.value || '';
      const dateFrom = document.getElementById('filter-log-date-from')?.value || '';
      const dateTo = document.getElementById('filter-log-date-to')?.value || '';

      filteredLogs = allLogs.filter(log => {
        // Filtro por empleado
        if (employeeFilter && log.nombre !== employeeFilter) return false;

        // Filtro por tipo
        if (typeFilter && log.tipo !== typeFilter) return false;

        // Filtro por fecha desde
        if (dateFrom) {
          const logDate = new Date(log.fecha).toISOString().split('T')[0];
          if (logDate < dateFrom) return false;
        }

        // Filtro por fecha hasta
        if (dateTo) {
          const logDate = new Date(log.fecha).toISOString().split('T')[0];
          if (logDate > dateTo) return false;
        }

        return true;
      });

      renderLogsTable();
      updateLogStats();
    }

    function clearLogFilters() {
      document.getElementById('filter-log-employee').value = '';
      document.getElementById('filter-log-type').value = '';
      document.getElementById('filter-log-date-from').value = '';
      document.getElementById('filter-log-date-to').value = '';

      filteredLogs = [...allLogs];
      renderLogsTable();
      updateLogStats();
    }

    function updateLogStats() {
      const totalLogs = allLogs.length;
      const totalEntries = allLogs.filter(log => log.tipo === 'ENTRADA').length;
      const totalExits = allLogs.filter(log => log.tipo === 'SALIDA').length;
      const filteredCount = filteredLogs.length;

      document.getElementById('stat-total-logs').textContent = totalLogs;
      document.getElementById('stat-total-entries').textContent = totalEntries;
      document.getElementById('stat-total-exits').textContent = totalExits;
      document.getElementById('stat-filtered-logs').textContent = filteredCount;
    }

    async function renderLogsTable() {
      const container = document.getElementById('logs-table-container');
      if (!container) return;

      const configRes = await fetch('/api/config');
      const config = await configRes.json();

      container.innerHTML = `
        <table class="w-full border-collapse table-fixed">
          <thead>
            <tr class="bg-gray-200 border-b">
              <th class="p-3 text-center font-semibold" style="width: 80px;">ID</th>
              <th class="p-3 text-left font-semibold">Empleado</th>
              <th class="p-3 text-center font-semibold" style="width: 140px;">Tipo</th>
              <th class="p-3 text-left font-semibold" style="width: 180px;">Fecha/Hora</th>
              <th class="p-3 text-center font-semibold" style="width: 180px;">M√©todo / Validaci√≥n</th>
            </tr>
          </thead>
          <tbody>
            ${filteredLogs.length === 0 ? '<tr><td colspan="5" class="p-3 text-center text-gray-500">No hay registros</td></tr>' :
          filteredLogs.map(log => {
            const esQR = log.lat === 0 && log.lon === 0;
            let metodoBadge = '';

            if (esQR) {
              metodoBadge = '<span class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-800">üì± QR</span>';
            } else {
              const R = 6371000;
              const restaurantLat = config.lat;
              const restaurantLon = config.lon;
              const maxDist = config.maxDistance;

              const dLat = (log.lat - restaurantLat) * Math.PI / 180;
              const dLon = (log.lon - restaurantLon) * Math.PI / 180;
              const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(restaurantLat * Math.PI / 180) * Math.cos(log.lat * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
              const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
              const distancia = Math.round(R * c);
              const enRango = distancia <= maxDist;

              if (enRango) {
                metodoBadge = '<span class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-800">‚úì GPS (' + distancia + 'm)</span>';
              } else {
                metodoBadge = '<span class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800">‚úó GPS (' + distancia + 'm)</span>';
              }
            }

            return '<tr class="border-b hover:bg-gray-50">' +
              '<td class="p-3 text-center" style="vertical-align: middle;">' + log.id + '</td>' +
              '<td class="p-3 font-semibold" style="vertical-align: middle;">' + log.nombre + '</td>' +
              '<td class="p-3 text-center" style="vertical-align: middle;">' +
              '<span class="inline-block px-3 py-1 rounded-full text-sm font-semibold ' + (log.tipo === 'ENTRADA' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800') + '">' +
              (log.tipo === 'ENTRADA' ? 'üìç ' : 'üö™ ') + log.tipo +
              '</span>' +
              '</td>' +
              '<td class="p-3" style="vertical-align: middle;">' + new Date(log.fecha).toLocaleString('es-ES') + '</td>' +
              '<td class="p-3 text-center" style="vertical-align: middle;">' + metodoBadge + '</td>' +
              '</tr>';
          }).join('')
        }
          </tbody>
        </table>
      `;
    }

    function exportFilteredLogsToCSV() {
      if (filteredLogs.length === 0) {
        Swal.fire({
          icon: 'warning',
          title: 'Sin datos',
          text: 'No hay registros para exportar'
        });
        return;
      }

      const csv = [
        ['ID', 'Empleado', 'Tipo', 'Fecha', 'Hora', 'Latitud', 'Longitud'],
        ...filteredLogs.map(log => {
          const fecha = new Date(log.fecha);
          return [
            log.id,
            log.nombre,
            log.tipo,
            fecha.toLocaleDateString('es-ES'),
            fecha.toLocaleTimeString('es-ES'),
            log.lat,
            log.lon
          ];
        })
      ].map(row => row.join(',')).join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `fichajes_filtrados_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();

      Swal.fire({
        icon: 'success',
        title: 'Exportado',
        text: `${filteredLogs.length} registros exportados correctamente`,
        timer: 2000,
        showConfirmButton: false
      });
    }

    async function deleteAllLogs() {
      const result = await Swal.fire({
        title: '¬øEliminar TODOS los fichajes?',
        text: '‚ö†Ô∏è Esta acci√≥n NO se puede deshacer. Se eliminar√°n todos los registros de fichajes.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'S√≠, eliminar todo',
        cancelButtonText: 'Cancelar'
      });

      if (result.isConfirmed) {
        try {
          const response = await fetch('/api/logs', {
            method: 'DELETE'
          });

          if (response.ok) {
            Swal.fire({
              icon: 'success',
              title: '¬°Eliminados!',
              text: 'Todos los registros han sido eliminados',
              timer: 2000
            });
            await loadLogsData();
          } else {
            throw new Error('Error al eliminar');
          }
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudieron eliminar los registros'
          });
        }
      }
    }

    async function deleteLogsByEmployee() {
      const uniqueEmployees = [...new Set(allLogs.map(log => log.nombre))];

      if (uniqueEmployees.length === 0) {
        Swal.fire({
          icon: 'info',
          title: 'Sin datos',
          text: 'No hay registros de fichajes'
        });
        return;
      }

      const { value: employeeName } = await Swal.fire({
        title: 'Selecciona un empleado',
        input: 'select',
        inputOptions: uniqueEmployees.reduce((obj, name) => {
          obj[name] = name;
          return obj;
        }, {}),
        inputPlaceholder: 'Selecciona un empleado',
        showCancelButton: true,
        cancelButtonText: 'Cancelar',
        confirmButtonText: 'Siguiente',
        inputValidator: (value) => {
          if (!value) {
            return 'Debes seleccionar un empleado';
          }
        }
      });

      if (employeeName) {
        const employeeLogs = allLogs.filter(log => log.nombre === employeeName);

        const result = await Swal.fire({
          title: `¬øEliminar fichajes de ${employeeName}?`,
          text: `Se eliminar√°n ${employeeLogs.length} registros de fichajes`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#dc2626',
          cancelButtonColor: '#6b7280',
          confirmButtonText: 'S√≠, eliminar',
          cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
          try {
            const response = await fetch(`/api/logs/employee/${employeeName}`, {
              method: 'DELETE'
            });

            if (response.ok) {
              Swal.fire({
                icon: 'success',
                title: '¬°Eliminados!',
                text: `Se eliminaron ${employeeLogs.length} registros de ${employeeName}`,
                timer: 2000
              });
              await loadLogsData();
            } else {
              throw new Error('Error al eliminar');
            }
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'No se pudieron eliminar los registros'
            });
          }
        }
      }
    }

    function calculateStats(horarios) {
      const diasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

      // Calcular horas totales por semana
      let totalMinutosSemanales = 0;
      let diasTrabajados = new Set();

      horarios.forEach(h => {
        const [horaIni, minIni] = h.hora_inicio.split(':').map(Number);
        const [horaFin, minFin] = h.hora_fin.split(':').map(Number);

        const minutosInicio = horaIni * 60 + minIni;
        const minutosFin = horaFin * 60 + minFin;
        const duracion = minutosFin - minutosInicio;

        totalMinutosSemanales += duracion;
        diasTrabajados.add(h.dia_semana);
      });

      const horasSemanales = Math.floor(totalMinutosSemanales / 60);
      const minutosSemanales = totalMinutosSemanales % 60;
      const horasMensuales = Math.floor((totalMinutosSemanales * 4.33) / 60); // Promedio mensual
      const diasLibres = 7 - diasTrabajados.size;

      // Actualizar estad√≠sticas en el DOM
      const statHoursWeek = document.getElementById('stat-hours-week');
      const statHoursMonth = document.getElementById('stat-hours-month');
      const statDaysWorked = document.getElementById('stat-days-worked');
      const statDaysFree = document.getElementById('stat-days-free');

      if (statHoursWeek) statHoursWeek.textContent = `${horasSemanales}h ${minutosSemanales}m`;
      if (statHoursMonth) statHoursMonth.textContent = `${horasMensuales}h`;
      if (statDaysWorked) statDaysWorked.textContent = diasTrabajados.size;
      if (statDaysFree) statDaysFree.textContent = diasLibres;
    }

    async function exportSchedule() {
      const scheduleContent = document.getElementById('schedule-content');
      const viewSelect = document.getElementById('employee-view');
      const view = viewSelect ? viewSelect.value : 'week';

      const viewNames = {
        'week': 'Semanal',
        'month': 'Mensual',
        'quarter': 'Trimestral'
      };

      Swal.fire({
        title: 'Exportando...',
        text: 'Generando PDF de tu horario',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      try {
        // Usar html2canvas para capturar el contenido
        const { default: html2canvas } = await import('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/+esm');
        const { jsPDF } = await import('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/+esm');

        const canvas = await html2canvas(scheduleContent, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false
        });

        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
          orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = pageWidth - 20;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        // A√±adir t√≠tulo
        pdf.setFontSize(16);
        pdf.text(`Mi Horario - Vista ${viewNames[view]}`, pageWidth / 2, 15, { align: 'center' });
        pdf.setFontSize(10);
        pdf.text(`${currentUser.nombre} - ${new Date().toLocaleDateString('es-ES')}`, pageWidth / 2, 22, { align: 'center' });

        // A√±adir imagen
        pdf.addImage(imgData, 'PNG', 10, 28, imgWidth, Math.min(imgHeight, pageHeight - 40));

        pdf.save(`horario_${currentUser.nombre.replace(/\s/g, '_')}_${view}_${new Date().toISOString().split('T')[0]}.pdf`);

        Swal.fire({
          icon: 'success',
          title: '¬°Exportado!',
          text: 'Tu horario se ha descargado correctamente',
          confirmButtonColor: '#0891b2'
        });
      } catch (error) {
        console.error('Error al exportar:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'No se pudo exportar el horario. Intenta de nuevo.'
        });
      }
    }

    // === FUNCIONES PARA QR ===
    let qrInterval = null;
    let qrProgressInterval = null;

    function cambiarMetodoFichaje(metodo) {
      // Mostrar/ocultar secciones seg√∫n el m√©todo elegido
      const gpsSection = document.getElementById('config-gps-section');
      const qrSection = document.getElementById('config-qr-section');

      if (metodo === 'gps') {
        gpsSection.classList.remove('hidden');
        qrSection.classList.add('hidden');
      } else if (metodo === 'qr') {
        gpsSection.classList.add('hidden');
        qrSection.classList.remove('hidden');
      } else { // ambos
        gpsSection.classList.remove('hidden');
        qrSection.classList.remove('hidden');
      }

      // Guardar configuraci√≥n autom√°ticamente
      saveConfig();
    }

    function showTab(tabName) {
      // Ocultar todos los tabs
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
      document.querySelectorAll('[id^="tab-"]').forEach(btn => {
        btn.classList.remove('border-cyan-600', 'text-cyan-600', 'font-bold');
        btn.classList.add('text-slate-500', 'font-semibold');
      });

      // Mostrar el tab seleccionado
      document.getElementById(`content-${tabName}`).classList.remove('hidden');
      const selectedTab = document.getElementById(`tab-${tabName}`);
      selectedTab.classList.add('border-cyan-600', 'text-cyan-600', 'font-bold');
      selectedTab.classList.remove('text-slate-500', 'font-semibold');
    }

    function logout() {
      currentUser = null;
      loadUsers().then(() => renderLogin());
    }

    loadUsers().then(() => renderLogin());
  </script>
</body>

</html>